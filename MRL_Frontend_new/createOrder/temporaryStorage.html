<link href="/static/frontend/Mrl/mrl_luma/zh_Hant_TW/css/emoji.min.css" rel="stylesheet" />

<!-- 功能選單 -->
<div class="menu-button" id="menuButton">
    <div class="menu-icon"></div>
    <div class="menu-content" id="menuContent">
        <button class="menu-item" id="saveDataBtn">儲存</button>
        <button class="menu-item" id="clearItems">清空產品清單</button>
        <button class="menu-item" id="loadTempDataBtn">載入</button>
    </div>
</div>

<!-- 暫存List poppup -->
<dialog id="userDataDialog">
    <h2 style="color: #fff">
        還原客戶暫存資料
        <span class="remonded-text">(若資料在48小時內未受到編輯，將會自動刪除)</span>
    </h2>
    <div id="popupContent"></div>
    <button id="closeDialogBtn">關閉</button>
</dialog>

//顯示儲存成功message
<div id="saveSuccessMessage" class="button-53">
    <p>欄位已成功儲存!</p>
</div>

<dialog id="initBlock">
    <div class="checkEmail">
        <h2 style="margin: 0">請輸入客戶Email：</h2>
        <input type="email" id="customerEmail" />
        <button id="emailComfirm">確認</button>
    </div>
    <div style="margin-top: 30px">
        <h2 style="color: #fff">
            還原客戶暫存資料
            <span class="remonded-text">(若資料在48小時內未受到編輯，將會自動刪除)</span>
        </h2>
        <div id="tempDataList"></div>
    </div>
</dialog>

<style>
    #initBlock {
        display: none;
        top: 10%;
    }

    .checkEmail {
        display: flex;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: solid #fff;
    }

    #emailComfirm {
        position: unset;
        margin-left: 10px;
        background-color: #f0c418;
        color: #514943;
        border-radius: inherit;
        padding: 0.6rem 1rem 0.6rem;
        border: #adadad solid;
    }

    #customerEmail {
        color: #000;
        width: 25rem;
        font-weight: 400;
    }

    dialog {
        opacity: 0.95;
        background-color: #2c2e33;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        margin: auto;
        font-weight: bold;
        letter-spacing: 2px;
        color: #fff;
        cursor: pointer;
        padding: 2.25em 1.5em;
        position: fixed;
        overflow: hidden;
        border: none;
        box-shadow: rgba(0, 0, 0, 0.4) 5px 5px, rgba(0, 0, 0, 0.3) 10px 10px,
            rgba(0, 0, 0, 0.2) 15px 15px, rgba(0, 0, 0, 0.1) 20px 20px,
            rgba(0, 0, 0, 0.05) 25px 25px;
    }

    dialog[open] {
        animation: fadeIn 0.5s ease;
        overflow: auto;
    }

    dialog[open]::-webkit-scrollbar {
        background: #2c2e33;
        width: 10px;
    }

    dialog[open]::-webkit-scrollbar-thumb {
        background: #fff;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    dialog h2 {
        color: #fff;
    }

    .dialogOption {
        color: #fff;
        font-weight: bold;
        padding: 15px;
        transition: background-color 0.3s ease;
        cursor: pointer;
    }

    .dialogOption:hover {
        background-color: #737679;
        color: #2c2e33;
    }

    dialog strong {
        color: #fff;
    }

    dialog p {
        color: #fff;
    }

    dialog button {
        position: relative;
        top: 10px;
        left: 85%;
        padding: 10px 20px;
        background-color: #ff3333;
        color: #ffffff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    dialog button:hover {
        background-color: #f75a5a;
    }

    #remindInputEmail {
        color: red;
        font-weight: bold;
        margin-top: 10px;
    }

    .remonded-text {
        font-size: 12px;
        color: #f4f446;
    }

    .button-53.show {
        opacity: 1;
        transform: rotate(-2deg) translateY(0);
    }

    .button-53 {
        opacity: 0;
        text-align: center;
        background-color: #2ebc4f;
        border: 0 solid #e5e7eb;
        box-sizing: border-box;
        color: #fff;
        display: flex;
        font-size: 1.5rem;
        font-weight: 700;
        justify-content: center;
        line-height: 1.75rem;
        padding: 0.75rem 1.65rem;
        position: fixed;
        width: 100%;
        max-width: 170px;
        cursor: pointer;
        transform: rotate(-2deg) translateY(-50%);
        transition: opacity 0.5s, transform 0.5s;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        top: 12%;
        left: 50%;
    }

    .button-53:focus {
        outline: 0;
    }

    .button-53:after {
        content: "";
        position: absolute;
        border: 1px solid #000000;
        bottom: 4px;
        left: 4px;
        width: calc(100% - 1px);
        height: calc(100% - 1px);
    }

    .menu-button {
        z-index: 2;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 100000;
    }

    .menu-button:hover {
        transform: scale(1.1);
    }

    .menu-icon {
        width: 30px;
        height: 5px;
        background-color: #ffffff;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
    }

    .menu-content {
        background-color: #fff;
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 0;
        height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
    }

    .menu-item {
        display: block;
        width: 100%;
        padding: 16px;
        text-align: center;
        background-color: #ffffff;
        border: none;
        cursor: pointer;
        margin: 0;
        transition: background-color 0.3s ease;
    }

    .menu-item:hover {
        background-color: #007bff;
        color: #fff;
    }

    #loadTempDataBtn {
        background-color: #2f4f4f;
        color: #fff;
    }

    #loadTempDataBtn:hover {
        background-color: #007bff;
        color: #fff;
    }

    .page-main-actions .page-actions._fixed {
        visibility: visible !important;
    }

    .deleteButton {
        position: relative;
        top: -35px;
        left: 95%;
    }

    .em-warning {
        height: 2em;
        width: 2em;
        position: relative;
        left: 130px;
        bottom: 53px;
    }

    #userDataDialog .sureBtn {
        top: 20px;
        left: 70%;
        margin: 10px 0;
    }

    #userDataDialog .closeBtn {
        top: 20px;
        left: 70%;
        margin: 10px 0 10px 25px;
        background-color: #f4f446;
        color: #2c2e33;
    }
</style>
<script>
    // 重構後的模組化程式碼
    
    // ================================
    // 常數定義
    // ================================
    const LOCAL_STORAGE_KEYS = {
        USER_DATA: 'allUserData',
        CACHED_ITEM_IDS: 'allCachedItemIDs',
        ITEM_DATA: 'allItemData'
    };

    const CSS_CLASSES = {
        VISIBLE: 'show',
        DIALOG_OPTION: 'dialogOption',
        DELETE_BUTTON: 'deleteButton',
        ORDER_TABLES: 'order-tables',
        EMPTY_TEXT: 'empty-text'
    };

    const SELECTORS = {
        EMAIL_FIELD: '#email',
        LAST_NAME_FIELD: '#order-billing_address_lastname',
        FIRST_NAME_FIELD: '#order-billing_address_firstname',
        MENU_BUTTON: '#menuButton',
        MENU_CONTENT: '#menuContent',
        SAVE_DATA_BTN: '#saveDataBtn',
        CLEAR_ITEMS: '#clearItems',
        LOAD_TEMP_DATA_BTN: '#loadTempDataBtn',
        USER_DATA_DIALOG: '#userDataDialog',
        POPUP_CONTENT: '#popupContent',
        CLOSE_DIALOG_BTN: '#closeDialogBtn',
        SAVE_SUCCESS_MESSAGE: '#saveSuccessMessage',
        INIT_BLOCK: '#initBlock',
        CUSTOMER_EMAIL: '#customerEmail',
        EMAIL_CONFIRM: '#emailComfirm',
        TEMP_DATA_LIST: '#tempDataList',
        ORDER_DETAILS: '.order-details',
        SALES_ORDER_CREATE_SEARCH_GRID: '#sales_order_create_search_grid',
        SALES_ORDER_CREATE_SEARCH_GRID_TABLE: '#sales_order_create_search_grid_table tr',
        ADD_PRODUCTS: '#add_products',
        ORDER_ITEMS: '#order-items',
        MRL_UPDATE_ATTRIBUTES: '#mrl_update_attributes',
        ORDER_HEADER: '#order-header'
    };

    const FIELD_TYPES = {
        RADIO: 'radio',
        CHECKBOX: 'checkbox',
        FIELDSET: 'fieldset'
    };

    const CONFIG = {
        DATA_EXPIRY_TIME: 48 * 60 * 60 * 1000,
        SUCCESS_MESSAGE_DISPLAY_TIME: 3000,
        PRODUCT_REMOVAL_DELAY: 1500,
        EMAIL_FORMAT_REGEX: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    };

    const MESSAGES = {
        DATA_SAVED: '資料已儲存!',
        FIELD_SAVED_SUCCESS: '欄位已成功儲存!',
        CONFIRM_CLEAR_ITEMS: '確定清除產品清單嗎?',
        PLEASE_INPUT_EMAIL: '請輸入Email',
        EMAIL_CHANGED_ALERT: '原儲存資料的Email已被更改，已自動更新暫存資料',
        NO_TEMP_DATA: '目前沒有任何暫存資料。',
        NO_CUSTOMER_DATA: '此客戶目前沒有任何暫存資料。'
    };

    const DIALOG_CONTENT = {
        TEMP_DATA_TITLE: '還原客戶暫存資料',
        TEMP_DATA_SUBTITLE: '(若資料在48小時內未受到編輯，將會自動刪除)',
        LOAD_REMINDER_TITLE: '載入提醒',
        LOAD_REMINDER_MESSAGE: '選取載入的資料Email與原本不同，確認要載入覆蓋嗎?',
        YES_BUTTON: 'YES',
        NO_BUTTON: 'NO',
        CLOSE_BUTTON: '關閉'
    };

    // ================================
    // StorageManager 類別
    // ================================
    class StorageManager {
        constructor() {
            this.storageKeys = LOCAL_STORAGE_KEYS;
        }

        getLocalStorageData(key, defaultValue = {}) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error(`Error parsing localStorage data for key "${key}":`, error);
                return defaultValue;
            }
        }

        setLocalStorageData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error(`Error saving data to localStorage for key "${key}":`, error);
                return false;
            }
        }

        removeLocalStorageData(key) {
            try {
                localStorage.removeItem(key);
            } catch (error) {
                console.error(`Error removing localStorage data for key "${key}":`, error);
            }
        }

        getAllUserData() {
            return this.getLocalStorageData(this.storageKeys.USER_DATA);
        }

        saveUserData(email, userData) {
            const allUserData = this.getAllUserData();
            allUserData[email] = {
                ...userData,
                timestamp: new Date().getTime()
            };
            return this.setLocalStorageData(this.storageKeys.USER_DATA, allUserData);
        }

        getUserData(email) {
            const allUserData = this.getAllUserData();
            return allUserData[email] || null;
        }

        deleteUserData(email) {
            const allUserData = this.getAllUserData();
            const allItemData = this.getAllItemData();
            const allCachedItemIDs = this.getAllCachedItemIDs();

            delete allUserData[email];
            delete allItemData[email];
            delete allCachedItemIDs[email];

            const userDataSuccess = Object.keys(allUserData).length > 0 
                ? this.setLocalStorageData(this.storageKeys.USER_DATA, allUserData)
                : (this.removeLocalStorageData(this.storageKeys.USER_DATA), true);

            const itemDataSuccess = Object.keys(allItemData).length > 0
                ? this.setLocalStorageData(this.storageKeys.ITEM_DATA, allItemData)
                : (this.removeLocalStorageData(this.storageKeys.ITEM_DATA), true);

            const cachedItemIDsSuccess = Object.keys(allCachedItemIDs).length > 0
                ? this.setLocalStorageData(this.storageKeys.CACHED_ITEM_IDS, allCachedItemIDs)
                : (this.removeLocalStorageData(this.storageKeys.CACHED_ITEM_IDS), true);

            return userDataSuccess && itemDataSuccess && cachedItemIDsSuccess;
        }

        getAllItemData() {
            return this.getLocalStorageData(this.storageKeys.ITEM_DATA);
        }

        saveItemData(email, productSku, itemData) {
            const allItemData = this.getAllItemData();
            allItemData[email] = allItemData[email] || {};
            allItemData[email][productSku] = itemData;
            return this.setLocalStorageData(this.storageKeys.ITEM_DATA, allItemData);
        }

        getUserItemData(email) {
            const allItemData = this.getAllItemData();
            return allItemData[email] || {};
        }

        getAllCachedItemIDs() {
            return this.getLocalStorageData(this.storageKeys.CACHED_ITEM_IDS);
        }

        saveCachedItemID(email, sku, itemInfo) {
            const allCachedItemIDs = this.getAllCachedItemIDs();
            allCachedItemIDs[email] = allCachedItemIDs[email] || {};
            allCachedItemIDs[email][sku] = itemInfo;
            return this.setLocalStorageData(this.storageKeys.CACHED_ITEM_IDS, allCachedItemIDs);
        }

        deleteCachedItemID(email, sku) {
            const allCachedItemIDs = this.getAllCachedItemIDs();
            
            if (allCachedItemIDs[email] && allCachedItemIDs[email][sku]) {
                delete allCachedItemIDs[email][sku];
                
                if (Object.keys(allCachedItemIDs[email]).length === 0) {
                    delete allCachedItemIDs[email];
                }
                
                return this.setLocalStorageData(this.storageKeys.CACHED_ITEM_IDS, allCachedItemIDs);
            }
            
            return true;
        }

        getUserCachedItemIDs(email) {
            const allCachedItemIDs = this.getAllCachedItemIDs();
            return allCachedItemIDs[email] || {};
        }

        updateUserEmail(oldEmail, newEmail) {
            try {
                const allUserData = this.getAllUserData();
                const allItemData = this.getAllItemData();
                const allCachedItemIDs = this.getAllCachedItemIDs();

                if (allUserData[oldEmail]) {
                    allUserData[newEmail] = allUserData[oldEmail];
                    delete allUserData[oldEmail];
                }

                if (allItemData[oldEmail]) {
                    allItemData[newEmail] = allItemData[oldEmail];
                    delete allItemData[oldEmail];
                }

                if (allCachedItemIDs[oldEmail]) {
                    allCachedItemIDs[newEmail] = allCachedItemIDs[oldEmail];
                    delete allCachedItemIDs[oldEmail];
                }

                const userDataSuccess = this.setLocalStorageData(this.storageKeys.USER_DATA, allUserData);
                const itemDataSuccess = this.setLocalStorageData(this.storageKeys.ITEM_DATA, allItemData);
                const cachedItemIDsSuccess = this.setLocalStorageData(this.storageKeys.CACHED_ITEM_IDS, allCachedItemIDs);

                return userDataSuccess && itemDataSuccess && cachedItemIDsSuccess;
            } catch (error) {
                console.error('Error updating user email:', error);
                return false;
            }
        }

        cleanupExpiredData() {
            let cleanedCount = 0;
            const now = new Date().getTime();
            
            try {
                const allUserData = this.getAllUserData();
                const allItemData = this.getAllItemData();
                const allCachedItemIDs = this.getAllCachedItemIDs();

                Object.keys(allUserData).forEach(email => {
                    const userData = allUserData[email];
                    if (userData.timestamp && (now - userData.timestamp > CONFIG.DATA_EXPIRY_TIME)) {
                        delete allUserData[email];
                        delete allItemData[email];
                        delete allCachedItemIDs[email];
                        cleanedCount++;
                    }
                });

                Object.keys(allItemData).forEach(email => {
                    if (!allUserData[email]) {
                        delete allItemData[email];
                    }
                });

                Object.keys(allCachedItemIDs).forEach(email => {
                    if (!allUserData[email]) {
                        delete allCachedItemIDs[email];
                    }
                });

                if (Object.keys(allUserData).length > 0) {
                    this.setLocalStorageData(this.storageKeys.USER_DATA, allUserData);
                } else {
                    this.removeLocalStorageData(this.storageKeys.USER_DATA);
                }

                if (Object.keys(allItemData).length > 0) {
                    this.setLocalStorageData(this.storageKeys.ITEM_DATA, allItemData);
                } else {
                    this.removeLocalStorageData(this.storageKeys.ITEM_DATA);
                }

                if (Object.keys(allCachedItemIDs).length > 0) {
                    this.setLocalStorageData(this.storageKeys.CACHED_ITEM_IDS, allCachedItemIDs);
                } else {
                    this.removeLocalStorageData(this.storageKeys.CACHED_ITEM_IDS);
                }

            } catch (error) {
                console.error('Error cleaning up expired data:', error);
            }

            return cleanedCount;
        }
    }

    // ================================
    // UIManager 類別
    // ================================
    class UIManager {
        constructor() {
            this.elements = this._cacheElements();
            this.menuIsOpen = false;
        }

        _cacheElements() {
            const elements = {};
            Object.entries(SELECTORS).forEach(([key, selector]) => {
                const element = document.querySelector(selector);
                if (element) {
                    elements[key] = element;
                }
            });
            return elements;
        }

        getElement(elementKey) {
            if (this.elements[elementKey]) {
                return this.elements[elementKey];
            }
            
            const selector = SELECTORS[elementKey];
            if (selector) {
                const element = document.querySelector(selector);
                if (element) {
                    this.elements[elementKey] = element;
                    return element;
                }
            }
            
            console.warn(`Element not found: ${elementKey}`);
            return null;
        }

        showSaveSuccessMessage(message = MESSAGES.FIELD_SAVED_SUCCESS) {
            const messageElement = this.getElement('SAVE_SUCCESS_MESSAGE');
            if (messageElement) {
                const textElement = messageElement.querySelector('p');
                if (textElement) {
                    textElement.textContent = message;
                }
                messageElement.classList.add(CSS_CLASSES.VISIBLE);
                
                setTimeout(() => {
                    messageElement.classList.remove(CSS_CLASSES.VISIBLE);
                }, CONFIG.SUCCESS_MESSAGE_DISPLAY_TIME);
            }
        }

        toggleMenu() {
            const menuContent = this.getElement('MENU_CONTENT');
            if (menuContent) {
                this.menuIsOpen = !this.menuIsOpen;
                
                if (this.menuIsOpen) {
                    menuContent.style.width = '120px';
                    menuContent.style.height = '150px';
                } else {
                    menuContent.style.width = '0';
                    menuContent.style.height = '0';
                }
            }
        }

        closeMenu() {
            const menuContent = this.getElement('MENU_CONTENT');
            if (menuContent) {
                this.menuIsOpen = false;
                menuContent.style.width = '0';
                menuContent.style.height = '0';
            }
        }

        buildTempDataListHTML(dataArray, isExistingCustomer = false, currentEmail = '') {
            if (!Array.isArray(dataArray) || dataArray.length === 0) {
                return `<p>${MESSAGES.NO_TEMP_DATA}</p>`;
            }

            let content = '';
            let hasValidData = false;

            dataArray.forEach((userData, index) => {
                if (isExistingCustomer && userData.email !== currentEmail) {
                    return;
                }

                hasValidData = true;
                content += this._buildDataOptionHTML(userData, index);
            });

            if (isExistingCustomer && !hasValidData) {
                return `<p>${MESSAGES.NO_CUSTOMER_DATA}</p>`;
            }

            return content || `<p>${MESSAGES.NO_TEMP_DATA}</p>`;
        }

        _buildDataOptionHTML(userData, index) {
            return `
                <div class="${CSS_CLASSES.DIALOG_OPTION}" data-index="${index}">
                    客戶: ${this._escapeHtml(userData.name)}<br/>
                    Email: ${this._escapeHtml(userData.email)}<br>
                </div>
                <i class="em em-x ${CSS_CLASSES.DELETE_BUTTON}" aria-role="presentation" aria-label="CROSS MARK"></i>
            `;
        }

        buildLoadConfirmHTML() {
            return `
                <div class="remindText">
                    <h1 style="color: #f4f446;">${DIALOG_CONTENT.LOAD_REMINDER_TITLE}</h1>
                    <i class="em em-warning" aria-role="presentation" aria-label="WARNING SIGN"></i>
                    <br>
                    <span style="font-size:16px">${DIALOG_CONTENT.LOAD_REMINDER_MESSAGE}</span>
                </div>
                <button class="sureBtn">${DIALOG_CONTENT.YES_BUTTON}</button>
                <button class="closeBtn">${DIALOG_CONTENT.NO_BUTTON}</button>
            `;
        }

        showTempDataDialog(content, onOptionClick, onDeleteClick, onClose) {
            const dialog = this.getElement('USER_DATA_DIALOG');
            const popupContent = this.getElement('POPUP_CONTENT');
            
            if (!dialog || !popupContent) {
                console.error('Dialog elements not found');
                return;
            }

            this._resetDialogContent(dialog);
            popupContent.innerHTML = content;
            dialog.showModal();
            this._attachDialogEvents(dialog, onOptionClick, onDeleteClick, onClose);
        }

        _resetDialogContent(dialog) {
            dialog.innerHTML = `
                <h2 style="color: #fff">
                    ${DIALOG_CONTENT.TEMP_DATA_TITLE}
                    <span class="remonded-text">${DIALOG_CONTENT.TEMP_DATA_SUBTITLE}</span>
                </h2>
                <div id="popupContent"></div>
                <button id="closeDialogBtn">${DIALOG_CONTENT.CLOSE_BUTTON}</button>
            `;
        }

        _attachDialogEvents(dialog, onOptionClick, onDeleteClick, onClose) {
            const closeBtn = dialog.querySelector('#closeDialogBtn');
            if (closeBtn && onClose) {
                closeBtn.addEventListener('click', onClose);
            }

            if (onOptionClick) {
                dialog.addEventListener('click', (e) => {
                    const option = e.target.closest(`.${CSS_CLASSES.DIALOG_OPTION}`);
                    if (option) {
                        const index = parseInt(option.getAttribute('data-index'));
                        onOptionClick(index, option);
                    }
                });
            }

            if (onDeleteClick) {
                dialog.addEventListener('click', (e) => {
                    if (e.target.classList.contains(CSS_CLASSES.DELETE_BUTTON)) {
                        const index = this._getDeleteButtonIndex(e.target);
                        onDeleteClick(index, e.target);
                    }
                });
            }
        }

        _getDeleteButtonIndex(deleteButton) {
            const allDeleteButtons = document.querySelectorAll(`.${CSS_CLASSES.DELETE_BUTTON}`);
            return Array.from(allDeleteButtons).indexOf(deleteButton);
        }

        closeDialog() {
            const dialog = this.getElement('USER_DATA_DIALOG');
            if (dialog) {
                dialog.close();
            }
        }

        showInitBlock(content, onEmailConfirm, onOptionClick, onDeleteClick) {
            const initBlock = this.getElement('INIT_BLOCK');
            const tempDataList = this.getElement('TEMP_DATA_LIST');
            
            if (!initBlock || !tempDataList) {
                console.error('Init block elements not found');
                return;
            }

            tempDataList.innerHTML = content;
            initBlock.style.display = 'block';

            const emailConfirmBtn = this.getElement('EMAIL_CONFIRM');
            if (emailConfirmBtn && onEmailConfirm) {
                emailConfirmBtn.addEventListener('click', onEmailConfirm);
            }

            this._attachInitBlockEvents(tempDataList, onOptionClick, onDeleteClick);
        }

        _attachInitBlockEvents(container, onOptionClick, onDeleteClick) {
            if (onOptionClick) {
                container.addEventListener('click', (e) => {
                    const option = e.target.closest(`.${CSS_CLASSES.DIALOG_OPTION}`);
                    if (option) {
                        const index = parseInt(option.getAttribute('data-index'));
                        onOptionClick(index, option);
                    }
                });
            }

            if (onDeleteClick) {
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains(CSS_CLASSES.DELETE_BUTTON)) {
                        const index = this._getDeleteButtonIndex(e.target);
                        onDeleteClick(index, e.target);
                    }
                });
            }
        }

        hideInitBlock() {
            const initBlock = this.getElement('INIT_BLOCK');
            if (initBlock) {
                initBlock.style.display = 'none';
            }
        }

        getCustomerEmailInput() {
            const emailInput = this.getElement('CUSTOMER_EMAIL');
            return emailInput ? emailInput.value.trim() : '';
        }

        isExistingCustomerOrder() {
            const pageTitle = this.getElement('ORDER_HEADER');
            if (pageTitle) {
                const titleText = pageTitle.textContent.toLowerCase();
                return titleText.includes('for') || titleText.includes('中的');
            }
            return false;
        }

        _escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        showAlert(message) {
            alert(message);
        }

        showConfirm(message) {
            return confirm(message);
        }

        waitForElement(selector, doc = document) {
            return new Promise((resolve, reject) => {
                const element = doc.querySelector(selector);
                if (element) {
                    return resolve(element);
                }

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        const parentElement = mutation.target.parentElement || doc;
                        const targetElement = parentElement.querySelector(selector);
                        if (targetElement) {
                            observer.disconnect();
                            resolve(targetElement);
                        }
                    });
                });

                observer.observe(doc, { 
                    childList: true, 
                    subtree: true 
                });
            });
        }

        observeLoadingMask(onLoadingComplete) {
            const popupLoading = document.querySelector('.popup-loading');
            
            if (!popupLoading) {
                console.warn('Loading mask not found');
                return;
            }

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            console.log('Popup loading appeared');
                        } else {
                            console.log('Popup loading disappeared');
                            if (onLoadingComplete) {
                                onLoadingComplete();
                            }
                            observer.disconnect();
                        }
                    });
                },
                { threshold: 0 }
            );

            observer.observe(popupLoading);
        }
    }


    // ================================
    // FormManager 類別
    // ================================
    class FormManager {
        constructor() {
            this.fieldIds = [];
            this.fields = {};
            this._initializeFields();
        }

        _initializeFields() {
            this._collectFieldIds();
            this._cacheFieldElements();
        }

        _collectFieldIds() {
            const allInputs = document.querySelectorAll('input');
            const allSelects = document.querySelectorAll('select');
            const allTextareas = document.querySelectorAll('textarea');

            [allInputs, allSelects, allTextareas].forEach(nodeList => {
                nodeList.forEach(element => {
                    if (element.id && element.id.trim() !== '') {
                        this.fieldIds.push(element.id);
                    }
                });
            });

            this.fieldIds = [...new Set(this.fieldIds)];
        }

        _cacheFieldElements() {
            this.fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    this.fields[id] = element;
                }
            });
        }

        getField(fieldId) {
            if (this.fields[fieldId]) {
                return this.fields[fieldId];
            }

            const element = document.getElementById(fieldId);
            if (element) {
                this.fields[fieldId] = element;
                return element;
            }

            return null;
        }

        collectAllFormData() {
            const formData = {};

            this.fieldIds.forEach(id => {
                const field = this.getField(id);
                if (field) {
                    const value = this.getFieldValue(field);
                    if (value !== null) {
                        formData[id] = value;
                    }
                }
            });

            return formData;
        }

        getFieldValue(field) {
            if (!field) return null;

            try {
                switch (field.type) {
                    case FIELD_TYPES.RADIO:
                        return field.checked ? field.value : null;
                    case FIELD_TYPES.CHECKBOX:
                        return field.checked;
                    case FIELD_TYPES.FIELDSET:
                        const textarea = field.querySelector('textarea');
                        return textarea ? textarea.value : '';
                    default:
                        return field.value;
                }
            } catch (error) {
                console.error(`Error getting field value for ${field.id}:`, error);
                return null;
            }
        }

        setFieldValue(fieldId, value) {
            const field = this.getField(fieldId);
            if (!field) {
                console.warn(`Field not found: ${fieldId}`);
                return false;
            }

            try {
                switch (field.type) {
                    case FIELD_TYPES.RADIO:
                        field.checked = true;
                        break;
                    case FIELD_TYPES.CHECKBOX:
                        field.checked = Boolean(value);
                        break;
                    case FIELD_TYPES.FIELDSET:
                        const textarea = field.querySelector('textarea');
                        if (textarea) {
                            textarea.value = value || '';
                        }
                        break;
                    default:
                        field.value = value || '';
                        break;
                }
                return true;
            } catch (error) {
                console.error(`Error setting field value for ${fieldId}:`, error);
                return false;
            }
        }

        clearAllFields() {
            this.fieldIds.forEach(id => {
                const field = this.getField(id);
                if (field) {
                    this._clearField(field);
                }
            });
        }

        _clearField(field) {
            try {
                switch (field.type) {
                    case FIELD_TYPES.RADIO:
                    case FIELD_TYPES.CHECKBOX:
                        field.checked = false;
                        break;
                    case FIELD_TYPES.FIELDSET:
                        const textarea = field.querySelector('textarea');
                        if (textarea) {
                            textarea.value = '';
                        }
                        break;
                    default:
                        field.value = '';
                        break;
                }
            } catch (error) {
                console.error(`Error clearing field ${field.id}:`, error);
            }
        }

        restoreFormData(formData, emailValue = '', lastNameValue = '', firstNameValue = '') {
            this.clearAllFields();

            if (emailValue) {
                this.setFieldValue('email', emailValue);
            }
            if (lastNameValue) {
                this.setFieldValue('order-billing_address_lastname', lastNameValue);
            }
            if (firstNameValue) {
                this.setFieldValue('order-billing_address_firstname', firstNameValue);
            }

            Object.keys(formData).forEach(fieldId => {
                this.setFieldValue(fieldId, formData[fieldId]);
            });
        }

        getUserBasicInfo() {
            const emailField = document.querySelector(SELECTORS.EMAIL_FIELD);
            const lastNameField = document.querySelector(SELECTORS.LAST_NAME_FIELD);
            const firstNameField = document.querySelector(SELECTORS.FIRST_NAME_FIELD);

            return {
                email: emailField ? emailField.value.trim() : '',
                lastName: lastNameField ? lastNameField.value.trim() : '',
                firstName: firstNameField ? firstNameField.value.trim() : '',
                fullName: this._getFullName(lastNameField, firstNameField)
            };
        }

        _getFullName(lastNameField, firstNameField) {
            const lastName = lastNameField ? lastNameField.value.trim() : '';
            const firstName = firstNameField ? firstNameField.value.trim() : '';
            return `${lastName}${firstName}`.trim();
        }

        validateEmail(email) {
            if (!email || typeof email !== 'string') {
                return false;
            }
            return CONFIG.EMAIL_FORMAT_REGEX.test(email.trim());
        }

        getChangedFieldInfo(event) {
            if (!event || !event.target) {
                return null;
            }

            const target = event.target;
            const fieldId = target.id;
            
            if (!fieldId) {
                return null;
            }

            if (this._isSpecialField(target)) {
                return null;
            }

            const field = this.getField(fieldId);
            if (!field) {
                return null;
            }

            return {
                fieldId,
                field,
                value: this.getFieldValue(field),
                isEmailField: fieldId === 'email',
                isCityField: fieldId === 'order-billing_address_city_id'
            };
        }

        _isSpecialField(target) {
            const parentNode = target.parentNode;
            
            if (!parentNode) {
                return false;
            }

            if (parentNode.id && parentNode.id.includes('sales_order_create_search_grid')) {
                return true;
            }

            if (parentNode.classList && parentNode.classList.contains('order-tables')) {
                return true;
            }

            return false;
        }

        setPreviousEmail(email) {
            const emailField = document.querySelector(SELECTORS.EMAIL_FIELD);
            if (emailField) {
                emailField.setAttribute('data-previousEmail', email);
            }
        }

        getPreviousEmail() {
            const emailField = document.querySelector(SELECTORS.EMAIL_FIELD);
            return emailField ? emailField.getAttribute('data-previousEmail') || '' : '';
        }

        createUserDataObject(email, name, formData) {
            return {
                email: email.trim(),
                name: name || '客戶',
                data: formData || {},
                timestamp: new Date().getTime()
            };
        }

        validateRequiredFields() {
            const basicInfo = this.getUserBasicInfo();
            
            return {
                hasEmail: Boolean(basicInfo.email),
                hasValidEmail: this.validateEmail(basicInfo.email),
                hasName: Boolean(basicInfo.fullName),
                email: basicInfo.email,
                name: basicInfo.fullName
            };
        }

        attachChangeListener(onChange) {
            const orderSheet = document.querySelector(SELECTORS.ORDER_DETAILS);
            
            if (orderSheet && onChange) {
                orderSheet.addEventListener('change', (event) => {
                    const fieldInfo = this.getChangedFieldInfo(event);
                    if (fieldInfo) {
                        onChange(fieldInfo, event);
                    }
                });
            }
        }

        attachEmailClickListener(onClick) {
            const emailField = document.querySelector(SELECTORS.EMAIL_FIELD);
            
            if (emailField && onClick) {
                emailField.addEventListener('click', (event) => {
                    const currentEmail = emailField.value;
                    this.setPreviousEmail(currentEmail);
                    if (onClick) {
                        onClick(currentEmail, event);
                    }
                });
            }
        }

        getAllFieldIds() {
            return [...this.fieldIds];
        }

        getAllFields() {
            return { ...this.fields };
        }

        reinitialize() {
            this.fieldIds = [];
            this.fields = {};
            this._initializeFields();
        }
    }

    // ================================
    // OrderDataManager 類別
    // ================================
    class OrderDataManager {
        constructor(storageManager) {
            this.storageManager = storageManager;
            this.removeSelectItemCount = 0;
            this._setupProductListObserver();
        }

        _setupProductListObserver() {
            const addPtForm = document.querySelector(SELECTORS.SALES_ORDER_CREATE_SEARCH_GRID);
            
            if (addPtForm) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' || mutation.type === 'attributes' || mutation.type === 'subtree') {
                            const productItems = document.querySelectorAll(SELECTORS.SALES_ORDER_CREATE_SEARCH_GRID_TABLE);
                            if (productItems.length > 0) {
                                this._attachProductItemEvents(productItems);
                            }
                        }
                    });
                });

                observer.observe(addPtForm, { 
                    attributes: false, 
                    childList: true, 
                    subtree: false 
                });
            }

            const addProductBtn = document.querySelector(SELECTORS.ADD_PRODUCTS);
            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    setTimeout(() => {
                        const productItems = document.querySelectorAll(SELECTORS.SALES_ORDER_CREATE_SEARCH_GRID_TABLE);
                        this._attachProductItemEvents(productItems);
                    }, 100);
                });
            }
        }

        _attachProductItemEvents(productItems) {
            productItems.forEach((item) => {
                if (item.dataset.eventAttached) return;
                
                item.addEventListener('click', (e) => this._handleProductEvent(e.currentTarget));
                item.addEventListener('change', (e) => this._handleProductEvent(e.currentTarget));
                
                item.dataset.eventAttached = 'true';
            });
        }

        _handleProductEvent(element) {
            try {
                const productInfo = this._extractProductInfo(element);
                if (!productInfo) return;

                const { email } = this._getCurrentUserInfo();
                if (!email) return;

                if (productInfo.isSelected) {
                    this._saveSelectedProduct(email, productInfo);
                } else {
                    this._removeSelectedProduct(email, productInfo.sku);
                }
            } catch (error) {
                console.error('Error handling product event:', error);
            }
        }

        _extractProductInfo(element) {
            try {
                const row = element.closest('tr');
                if (!row) return null;

                const idElement = row.querySelector('.col-id');
                const qtyElement = row.querySelector('.col-qty input');
                const skuElement = row.querySelector('.col-sku');
                const selectElement = row.querySelector('.col-select input');

                if (!idElement || !qtyElement || !skuElement || !selectElement) {
                    return null;
                }

                return {
                    itemID: idElement.innerText.trim(),
                    qty: qtyElement.value,
                    sku: skuElement.innerText.trim(),
                    isSelected: selectElement.checked
                };
            } catch (error) {
                console.error('Error extracting product info:', error);
                return null;
            }
        }

        _getCurrentUserInfo() {
            const emailField = document.querySelector(SELECTORS.EMAIL_FIELD);
            const lastNameField = document.querySelector(SELECTORS.LAST_NAME_FIELD);
            const firstNameField = document.querySelector(SELECTORS.FIRST_NAME_FIELD);

            const email = emailField ? emailField.value.trim() : '';
            const lastName = lastNameField ? lastNameField.value.trim() : '';
            const firstName = firstNameField ? firstNameField.value.trim() : '';

            return {
                email,
                name: `${lastName}${firstName}`.trim()
            };
        }

        _saveSelectedProduct(email, productInfo) {
            const itemKey = `item[${productInfo.itemID}][qty]`;
            const itemData = {
                [itemKey]: productInfo.qty
            };

            this.storageManager.saveCachedItemID(email, productInfo.sku, itemData);
        }

        _removeSelectedProduct(email, sku) {
            this.storageManager.deleteCachedItemID(email, sku);
        }

        saveOrderItemsData(email) {
            if (!email) return;

            const orderTableRows = document.querySelectorAll(`${SELECTORS.ORDER_TABLES} tbody`);
            
            orderTableRows.forEach((row) => {
                try {
                    const productSkuElement = row.querySelector('.product-sku-block');
                    if (!productSkuElement) return;

                    const productSku = productSkuElement.innerText.split(':')[1]?.trim();
                    if (!productSku) return;

                    const itemDate1Element = row.querySelector('.col-row-from-date-1 .input-date');
                    const itemDate2Element = row.querySelector('.col-row-to-date-2 .input-date');
                    const itemNoteElement = row.querySelector('.col-row-free-text textarea');

                    const itemData = {
                        itemDate_1: itemDate1Element ? itemDate1Element.value : '',
                        itemDate_2: itemDate2Element ? itemDate2Element.value : '',
                        itemNote: itemNoteElement ? itemNoteElement.value : ''
                    };

                    this.storageManager.saveItemData(email, productSku, itemData);
                } catch (error) {
                    console.error('Error saving order item data:', error);
                }
            });
        }

        restoreOrderItemsData(email) {
            if (!email) return;

            const userItemData = this.storageManager.getUserItemData(email);
            
            setTimeout(() => {
                const orderTableRows = document.querySelectorAll(`${SELECTORS.ORDER_TABLES} tbody`);
                
                orderTableRows.forEach((row) => {
                    try {
                        const productSkuElement = row.querySelector('.product-sku-block');
                        if (!productSkuElement) return;

                        const productSku = productSkuElement.innerText.split(':')[1]?.trim();
                        if (!productSku || !userItemData[productSku]) return;

                        const itemData = userItemData[productSku];

                        const itemDate1Element = row.querySelector('.col-row-from-date-1 .input-date');
                        const itemDate2Element = row.querySelector('.col-row-to-date-2 .input-date');
                        const itemNoteElement = row.querySelector('.col-row-free-text textarea');

                        if (itemDate1Element) itemDate1Element.value = itemData.itemDate_1 || '';
                        if (itemDate2Element) itemDate2Element.value = itemData.itemDate_2 || '';
                        if (itemNoteElement) itemNoteElement.value = itemData.itemNote || '';
                    } catch (error) {
                        console.error('Error restoring order item data:', error);
                    }
                });

                setTimeout(() => {
                    const updateAttributesBtn = document.querySelector(SELECTORS.MRL_UPDATE_ATTRIBUTES);
                    if (updateAttributesBtn) {
                        updateAttributesBtn.click();
                    }
                }, 2000);
            }, 500);
        }

        async restoreSelectedProducts(email) {
            if (!email) {
                console.warn('Email is required for restoring products');
                return Promise.resolve();
            }

            const cachedItemIDs = this.storageManager.getUserCachedItemIDs(email);
            
            if (Object.keys(cachedItemIDs).length === 0) {
                console.log('No cached products found for user');
                return Promise.resolve();
            }

            const area = ['search', 'items', 'shipping_method', 'totals', 'giftmessage', 'billing_method'];
            const fieldsPrepare = {};
            const itemsFilter = [];

            Object.keys(cachedItemIDs).forEach((sku) => {
                const itemData = cachedItemIDs[sku];
                Object.keys(itemData).forEach((key) => {
                    const itemIdMatch = key.match(/\[(\d+)\]/);
                    const itemId = itemIdMatch ? itemIdMatch[1] : null;
                    const qtyKey = `item[${itemId}][qty]`;
                    const qty = itemData[qtyKey];

                    if (qty !== undefined) {
                        fieldsPrepare[qtyKey] = qty;
                        itemsFilter.push({
                            item_id: itemId,
                            sku: sku
                        });
                    }
                });
            });

            if (window.order && window.order.productConfigureSubmit) {
                try {
                    window.order.productConfigureSubmit('product_to_add', area, fieldsPrepare, itemsFilter);
                    return Promise.resolve();
                } catch (error) {
                    console.error('Error restoring selected products:', error);
                    return Promise.reject(error);
                }
            } else {
                console.warn('Order object not found');
                return Promise.resolve();
            }
        }

        async removeAllSelectedProducts() {
            const existProduct = document.querySelectorAll(`${SELECTORS.ORDER_ITEMS} td.col-product > span`);
            
            if (existProduct.length === 0) {
                return Promise.resolve();
            }

            const existProductIds = Array.from(existProduct).map(item => {
                const match = item.id.match(/\d+/);
                return match ? match[0] : null;
            }).filter(id => id !== null);

            this.removeSelectItemCount = existProductIds.length;

            existProductIds.forEach(id => {
                if (window.order && window.order.removeQuoteItem) {
                    try {
                        window.order.removeQuoteItem(id);
                    } catch (error) {
                        console.error(`Error removing product ${id}:`, error);
                    }
                }
            });

            return new Promise((resolve) => {
                setTimeout(() => {
                    this.removeSelectItemCount = 0;
                    resolve();
                }, CONFIG.PRODUCT_REMOVAL_DELAY * existProductIds.length);
            });
        }

        syncTempData(email) {
            if (!email) return;

            const orderTableRows = document.querySelectorAll(`${SELECTORS.ORDER_TABLES} tbody`);

            orderTableRows.forEach((row) => {
                try {
                    const actionsElement = row.querySelector('.col-actions .admin__control-select');
                    if (!actionsElement || actionsElement.value !== 'remove') return;

                    const productSkuElement = row.querySelector('.product-sku-block');
                    if (!productSkuElement) return;

                    const productSku = productSkuElement.innerText.split(':')[1]?.trim();
                    if (!productSku) return;

                    this.storageManager.deleteCachedItemID(email, productSku);
                    
                    const allItemData = this.storageManager.getAllItemData();
                    if (allItemData[email] && allItemData[email][productSku]) {
                        delete allItemData[email][productSku];
                        this.storageManager.setLocalStorageData('allItemData', allItemData);
                    }
                } catch (error) {
                    console.error('Error syncing temp data:', error);
                }
            });
        }

        attachApplyButtonListener(onApplyClick) {
            this.waitForElement(SELECTORS.MRL_UPDATE_ATTRIBUTES)
                .then((button) => {
                    button.addEventListener('click', () => {
                        if (onApplyClick) {
                            onApplyClick();
                        }
                    });
                })
                .catch((error) => {
                    console.error('Apply button not found:', error);
                });
        }

        waitForElement(selector, doc = document) {
            return new Promise((resolve, reject) => {
                const element = doc.querySelector(selector);
                if (element) {
                    return resolve(element);
                }

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        const parentElement = mutation.target.parentElement || doc;
                        const targetElement = parentElement.querySelector(selector);
                        if (targetElement) {
                            observer.disconnect();
                            resolve(targetElement);
                        }
                    });
                });

                observer.observe(doc, { 
                    childList: true, 
                    subtree: true 
                });
            });
        }

        hasEmptyQuoteItems() {
            const checkQuote = document.querySelector(`${SELECTORS.ORDER_ITEMS} .${CSS_CLASSES.EMPTY_TEXT}`);
            return Boolean(checkQuote);
        }
    }

        ////////////Add product to order////////////

        ////監聽篩選器導致表格變動
        var addPtForm = document.querySelector("#sales_order_create_search_grid");
        var addPtFormObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (
                    mutation.type === "childList" ||
                    mutation.type === "attributes" ||
                    mutation.type === "subtree"
                ) {
                    var productItems = document.querySelectorAll(
                        "#sales_order_create_search_grid_table tr"
                    );
                    if (productItems) {
                        saveItemitemID(productItems);
                    }
                }
            });
        });

        var config = { attributes: false, childList: true, subtree: false };
        addPtFormObserver.observe(addPtForm, config);
        var addProductBtn = document.querySelector("#add_products");

        add_products.addEventListener("click", function () {
            var productItems = document.querySelectorAll(
                "#sales_order_create_search_grid_table tr"
            );
            saveItemitemID(productItems);
        });

        //儲存已選商品的item ID
        function saveItemitemID(productItems) {
            productItems.forEach(function (item) {
                item.addEventListener("click", function () {
                    handleEvent(this); //增加or減少產品
                });
                item.addEventListener("change", function () {
                    handleEvent(this); //修改產品數量
                });
            });
        }

        //依照表中產品選取狀態暫存or刪除
        function handleEvent(element) {
            var email = emailField.value;
            var name = lastNameField.value + firstNameField.value;

            var itemID = element.closest("tr").querySelector(".col-id").innerText;
            var itemQty = element.closest("tr").querySelector(".col-qty input").value;
            var itemSku = element.closest("tr").querySelector(".col-sku").innerText;
            var status = element
                .closest("tr")
                .querySelector(".col-select input").checked;
            var cacheditemIDs = {}; //已選產品暫存

            if (status) {
                updateAllCachedItemIDs(itemID, {
                    email: email,
                    qty: itemQty,
                    sku: itemSku,
                });
            } else {
                deleteItem(itemID, {
                    email: email,
                });
            }
        }

        // 刪除指定 itemID
        function deleteItem(itemID, cachedItem) {
            var allCachedItemIDs = getLocalStorageData("allCachedItemIDs");
            var userKey = cachedItem.email;

            if (userKey in allCachedItemIDs) {
                var userCachedItemIDs = allCachedItemIDs[userKey];
                delete userCachedItemIDs["item" + "[" + itemID + "]" + "[qty]"];

                if (Object.keys(userCachedItemIDs).length === 0) {
                    delete allCachedItemIDs[userKey];
                } else {
                    allCachedItemIDs[userKey] = userCachedItemIDs;
                }

                localStorage.setItem(
                    "allCachedItemIDs",
                    JSON.stringify(allCachedItemIDs)
                );
            }
        }

        // 更新或添加到 localStorage(allCachedItemIDs)
        function updateAllCachedItemIDs(itemID, cachedItem) {
            var allCachedItemIDs = getLocalStorageData("allCachedItemIDs");
            var userKey = cachedItem.email;

            var items = {};
            var key = "item" + "[" + itemID + "]" + "[qty]";
            items[key] = cachedItem.qty;

            allCachedItemIDs[userKey] = allCachedItemIDs[userKey] || {};
            allCachedItemIDs[userKey][cachedItem.sku] = items;
            localStorage.setItem("allCachedItemIDs", JSON.stringify(allCachedItemIDs));
        }

        //儲存&還原已添加的產品相關欄位資料(交期&備註)
        var itemSelector = {
            DATE_1: ".order-tables .col-row-from-date-1 .input-date",
            DATE_2: ".order-tables .col-row-to-date-2 .input-date",
            NOTE: ".order-tables .col-row-free-text .input-text",
        };

        function getValuesFromNodes(nodeList) {
            var values = [];
            nodeList.forEach(function (node) {
                values.push(node.value);
            });
            return values;
        }

        //儲存交期＆備註
        function saveItemData() {
            var email = emailField.value;
            var orderTableRows = document.querySelectorAll(".order-tables tbody");
            orderTableRows.forEach(function (row) {
                var productSku = row.querySelector(".product-sku-block").innerText.split(":")[1].trim();;
                var itemDate_1 = row.querySelector(".col-row-from-date-1 .input-date").value;
                var itemDate_2 = row.querySelector(".col-row-to-date-2 .input-date").value;
                var itemNote = row.querySelector(".col-row-free-text textarea").value;

                var items = {
                    itemDate_1: itemDate_1,
                    itemDate_2: itemDate_2,
                    itemNote: itemNote,
                };
                if (productSku) {
                    var allItemData = getLocalStorageData("allItemData") || {};
                    allItemData[email] = allItemData[email] || {};
                    allItemData[email][productSku] = items;
                    localStorage.setItem("allItemData", JSON.stringify(allItemData));
                }
            });
        }

        //還原交期＆備註
        function restoreItemData(selectedEmail) {
            var allItemData = getLocalStorageData("allItemData");

            if (selectedEmail in allItemData) {
                var items = allItemData[selectedEmail];

                var orderTableRows = document.querySelectorAll('.order-tables tbody')
                orderTableRows.forEach(function (row) {
                    var productSku = row.querySelector(".product-sku-block").innerText.split(":")[1].trim();
                    if (productSku in items) {
                        var itemDate_1 = items[productSku].itemDate_1;
                        var itemDate_2 = items[productSku].itemDate_2;
                        var itemNote = items[productSku].itemNote;

                        row.querySelector(".col-row-from-date-1 .input-date").value = itemDate_1 || "";
                        row.querySelector(".col-row-to-date-2 .input-date").value = itemDate_2 || "";
                        row.querySelector(".col-row-free-text textarea").value = itemNote || "";
                    }
                });
            }

            //觸發套用按鈕
            setTimeout(function () {
                document.querySelector("#mrl_update_attributes").click();
            }, 2000);
        }

        //監聽"套用"按鈕出現
        var updateAttribute = waitForElm("#mrl_update_attributes");
        updateAttribute
            .then(function (elm) {
                //點擊套用按鈕時儲存交期＆備註
                elm.addEventListener("click", function () {
                    saveDataToLocalStorage();
                    saveItemData();
                    syncTempData(emailField.value);
                });
            })
            .catch(function (err) {
                console.log(err);
            });

        //還原已選產品
        function restoreLastSelectedProduct(selectedEmail) {
            var cacheditemIDs = JSON.parse(localStorage.getItem("allCachedItemIDs"));

            if (!(selectedEmail in cacheditemIDs)) {
                userDataDialog.close();
                return console.log("暫存的商品資料不存在");
            }

            var area = [
                "search",
                "items",
                "shipping_method",
                "totals",
                "giftmessage",
                "billing_method",
            ];
            var fieldsPrepare = {};
            var itemsFilter = [];
            var foundObject = cacheditemIDs[selectedEmail];

            Object.keys(foundObject).forEach(function (sku) {
                var itemData = foundObject[sku];
                Object.keys(itemData).forEach(function (key) {
                    var itemIdMatch = key.match(/\[(\d+)\]/);
                    var itemId = itemIdMatch ? itemIdMatch[1] : null;
                    var qtyKey = 'item[' + itemId + '][qty]';
                    var qty = itemData[qtyKey];

                    if (qty !== undefined) {
                        fieldsPrepare[qtyKey] = qty;
                        itemsFilter.push({
                            item_id: itemId,
                            sku: sku,
                        });
                    }
                });
            });


            // fieldsPrepare = foundObject;
            // itemsFilter = String(foundObject).match(/item\[(\d+)\]\[qty\]/);
            //觸發添加產品function
            order.productConfigureSubmit(
                "product_to_add",
                area,
                fieldsPrepare,
                itemsFilter
            );
        }

        //移除已選產品
        var removeSelectItemNum = 0;
        function removeSelectItem() {
            var existProductArr = [];
            var existProduct = document.querySelectorAll(
                "#order-items td.col-product > span"
            );
            if (existProduct) {
                for (var i = 0; i < existProduct.length; i++) {
                    var itemId = existProduct[i].id.match(/\d+/).toString();
                    existProductArr.push(itemId);
                }

                existProductArr.forEach(function (id) {
                    removeSelectItemNum++;
                    order.removeQuoteItem(id);
                });
                existProductArr = [];
            } else {
                return;
            }
        }

        //監聽元素出現
        function waitForElm(selector, doc) {
            var scopeDoc = doc || document;
            var promise = new Promise(function (resolve, reject) {
                var el = scopeDoc.querySelector(selector);
                if (el) {
                    return resolve(el);
                }

                targetObserver = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        var targetEl = null;
                        var parentElement = mutation.target.parentElement || scopeDoc;
                        if (parentElement) {
                            targetEl = parentElement.querySelector(selector);
                        }
                        if (targetEl) {
                            resolve(targetEl);
                            targetObserver.disconnect();
                            return;
                        }
                    });
                });
                targetObserver.observe(scopeDoc, { childList: true, subtree: true });
            });

            return promise;
        }

        // 建構彈出式視窗的內容
        function buildPopupContent(dataArray) {
            var content = "";
            var isExistCustomer = checkCreateOrderForExistCustomer();
            var currentEmail = document.querySelector("#email").value;

            if (dataArray.length > 0) {
                dataArray.forEach(function (userData, index) {
                    // 既有客戶，顯示相同 email 的資料
                    if (isExistCustomer && userData.email !== currentEmail) {
                        return;
                    }
                    
                    content += "<div class='dialogOption' data-index= '" + index + "'>";
                    content +=
                        "客戶: " +
                        userData.name +
                        "<br/>" +
                        "Email: " +
                        userData.email +
                        "<br>";
                    content += "</div>";
                    content +=
                        '<i class="em em-x deleteButton" aria-role="presentation" aria-label="CROSS MARK"></i>';
                });
                
                if (isExistCustomer && content === "") {
                    content += "<p>此客戶目前沒有任何暫存資料。</p>";
                }
            } else {
                content += "<p>目前沒有任何暫存資料。</p>";
            }
            return content;
        }

        function checkCreateOrderForExistCustomer(){
            var pageTitle = document.querySelector('#order-header');
            if (pageTitle) {
                pageTitle = pageTitle.textContent.toLowerCase();
                if (pageTitle.includes('for') || pageTitle.includes('中的')) {
                    return true;
                }
            }
            return false;
        }
        //提醒用戶是否覆蓋資料視窗
        function coverDataConfirm() {
            var content = "";
            content += "<div class='remindText'>";
            content += "<h1 style='color: #f4f446;'>載入提醒 </h1>";
            content +=
                '<i class="em em-warning" aria-role="presentation" aria-label="WARNING SIGN"></i>';
            content += "<br>";
            content +=
                "<span style='font-size:16px'>選取載入的資料Email與原本不同，確認要載入覆蓋嗎?</span>";
            content += "</div>";

            content += "<button class='sureBtn'> YES </button>";
            content += "<button class='closeBtn'> NO </button>";
            return content;
        }

        // 顯示暫存資料List
        function showStoredDataDialog() {
            var storedData =
                Object.values(JSON.parse(localStorage.getItem("allUserData"))) || {};
            var userDataDialog = document.getElementById("userDataDialog");
            var popupContent = buildPopupContent(storedData);
            var popupContentElement = document.getElementById("popupContent");
            if (popupContentElement === null) {
                userDataDialog.innerHTML =
                    "<h2>還原客戶暫存資料 <span class='remonded-text'>(若資料在48小時內未受到編輯，將會自動刪除)</span></h2>" +
                    "<div id='popupContent'></div>" +
                    "<button id='closeDialogBtn'>關閉</button>";
                popupContentElement = document.getElementById("popupContent");
            }
            popupContentElement.innerHTML = popupContent;
            userDataDialog.showModal();

            //關閉
            var closeDialogBtn = document.getElementById("closeDialogBtn");
            closeDialogBtn.addEventListener("click", function () {
                userDataDialog.close();
            });

            //選擇欲還原的暫存資料
            var dialogOption = document.querySelectorAll(".dialogOption");
            dialogOption.forEach(function (option) {
                option.addEventListener("click", function (e) {
                    var selectedIndex = option.getAttribute("data-index");
                    var selectedEmail = storedData[selectedIndex].email;
                    //判斷是否覆蓋資料
                    if (
                        document.querySelector("#email").value !== selectedEmail &&
                        document.querySelector("#email").value !== ""
                    ) {
                        userDataDialog.innerHTML = coverDataConfirm();
                        userDataDialog.style.cursor = "unset";
                        userDataDialog.style.opacity = "1";
                        document
                            .querySelector("#userDataDialog .closeBtn")
                            .addEventListener("click", function () {
                                userDataDialog.close();
                                userDataDialog.innerHTML =
                                    "<h2>還原客戶暫存資料 <span class='remonded-text'>(若資料在48小時內未受到編輯，將會自動刪除)</span></h2> " +
                                    "<div id='popupContent'></div>" +
                                    "<button id='closeDialogBtn'>關閉</button>";
                            });
                        document
                            .querySelector("#userDataDialog .sureBtn")
                            .addEventListener("click", function () {
                                //覆蓋資料
                                var waitRemoveItem = new Promise(function (resolve, reject) {
                                    removeSelectItem();
                                    return resolve();
                                });
                                waitRemoveItem.then(function () {
                                    setTimeout(function () {
                                        restoreLastSelectedProduct(selectedEmail);
                                        loadingMaskShow(selectedEmail);
                                        selectUserData(storedData[selectedIndex]);
                                    }, 1500 * removeSelectItemNum);
                                    removeSelectItemNum = 0;
                                    userDataDialog.close();
                                    userDataDialog.innerHTML =
                                        "<h2>還原客戶暫存資料 <span class='remonded-text'>(若資料在48小時內未受到編輯，將會自動刪除)</span></h2> " +
                                        "<div id='popupContent'></div>" +
                                        "<button id='closeDialogBtn'>關閉</button>";
                                });
                            });
                    } else {
                        userDataDialog.close();
                        if (selectedEmail) {
                            if (selectedEmail === document.getElementById("email").value) {
                                var waitRemoveItem = new Promise(function (resolve, reject) {
                                    removeSelectItem();
                                    return resolve();
                                });
                                waitRemoveItem.then(function () {
                                    setTimeout(function () {
                                        restoreLastSelectedProduct(selectedEmail);
                                        loadingMaskShow(selectedEmail);
                                    }, 1500 * removeSelectItemNum);
                                    removeSelectItemNum = 0;
                                });
                                // return console.log("選取資料email與原本相同,不進行刪除與還原");
                            } else {
                                restoreLastSelectedProduct(selectedEmail);
                                loadingMaskShow(selectedEmail);
                            }
                        }
                        selectUserData(storedData[selectedIndex]);
                    }
                });
            });
            optionsDelete(); //監聽手動刪除選項
        }

        //暫存List用戶數據填入
        function selectUserData(userData) {
            //初始化表單值
            for (var id in fields) {
                if (fields.hasOwnProperty(id)) {
                    if (fields[id].type === "radio" || fields[id].type === "checkbox") {
                        fields[id].checked = false;
                    } else if (fields[id].type === "fieldset") {
                        fields[id].querySelector("textarea").value = "";
                    } else {
                        fields[id].value = "";
                    }
                }
            }

            //還原欄位資料
            var emailField = document.querySelector("#email");
            emailField.value = userData.email;
            lastNameField.value = userData.name.split(" ")[0];
            firstNameField.value = userData.name.split(" ")[1] || "";

            for (var dataId in userData.data) {
                if (userData.data.hasOwnProperty(dataId)) {
                    var field = fields[dataId];
                    if (field) {
                        if (field.type === "radio") {
                            field.checked = true;
                        } else if (field.type === "checkbox") {
                            field.checked = userData.data[dataId];
                        } else if (field.type === "fieldset") {
                            field.querySelector("textarea").value = userData.data[dataId];
                        } else {
                            field.value = userData.data[dataId];
                        }
                    }
                }
            }
        }

        // 更改用戶email時更新暫存商品資料
        function updateStoredDataOnEmailChange(oldEmail, newEmail) {
            var allUserData = getLocalStorageData("allUserData");
            var allItemData = getLocalStorageData("allItemData");
            var allCachedItemIDs = getLocalStorageData("allCachedItemIDs");

            if (oldEmail in allItemData && oldEmail in allCachedItemIDs) {
                var oldUserData = allUserData[oldEmail];
                var oldItemData = allItemData[oldEmail];
                var oldCachedItemIDs = allCachedItemIDs[oldEmail];

                //刪除舊資料
                delete allUserData[oldEmail];
                delete allItemData[oldEmail];
                delete allCachedItemIDs[oldEmail];
                //設置新資料
                allUserData[newEmail] = oldUserData;
                allItemData[newEmail] = oldItemData;
                allCachedItemIDs[newEmail] = oldCachedItemIDs;

                localStorage.setItem("allUserData", JSON.stringify(allUserData));
                localStorage.setItem("allItemData", JSON.stringify(allItemData));
                localStorage.setItem(
                    "allCachedItemIDs",
                    JSON.stringify(allCachedItemIDs)
                );
            }
        }

        //等待轉圈進入＆離開畫面
        function loadingMaskShow(selectedEmail) {
            var popupLoading = document.querySelector(".popup-loading");
            var observer = new IntersectionObserver(
                function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            console.log("Popup loading appeared");
                        } else {
                            console.log("Popup loading disappeared");
                            restoreItemData(selectedEmail);
                            observer.disconnect();
                        }
                    });
                },
                { threshold: 0 }
            );

            if (popupLoading) {
                observer.observe(popupLoading);
            }
        }

        //檢查資料存在時間
        function checkDataExistTime() {
            var dataKey;
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (key.includes("Data") || key.includes("ID")) {
                    var storedData = JSON.parse(localStorage.getItem(key));
                    dataKey = Object.keys(storedData)[0];
                    var storedTimestamp = storedData[dataKey].timestamp;
                    if (storedData !== null && storedTimestamp !== undefined) {
                        var now = new Date().getTime();
                        if (now - storedTimestamp > 48 * 60 * 60 * 1000) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            }
            removeExtraData(); //超過時間自動刪除多餘資料
        }

        function removeExtraData() {
            var allUserData = getLocalStorageData("allUserData");
            var allItemData = getLocalStorageData("allItemData");
            var allCachedItemIDs = getLocalStorageData("allCachedItemIDs");
            for (var userKey in allItemData) {
                if (!allUserData.hasOwnProperty(userKey)) {
                    delete allItemData[userKey];
                }
            }
            for (var userKey in allCachedItemIDs) {
                if (!allUserData.hasOwnProperty(userKey)) {
                    delete allCachedItemIDs[userKey];
                }
            }
            localStorage.setItem("allItemData", JSON.stringify(allItemData));
            localStorage.setItem(
                "allCachedItemIDs",
                JSON.stringify(allCachedItemIDs)
            );
        }

        checkDataExistTime();

        //進入頁面時填寫email or 載入暫存資料
        function makeUserInputEmail() {
            var customerEmail = document.querySelector("#email");

            if (customerEmail.value === "") {
                var storedData =
                    Object.values(JSON.parse(localStorage.getItem("allUserData"))) || {};
                var popupContent = buildPopupContent(storedData);
                var popupContentElement = document.getElementById("tempDataList");
                popupContentElement.innerHTML = popupContent;
                var initBlock = document.querySelector("#initBlock");
                initBlock.style.display = "block";
                var inputEmail = document.querySelector("#customerEmail");

                //選項點擊
                var dialogOption = document.querySelectorAll(".dialogOption");
                dialogOption.forEach(function (option) {
                    option.addEventListener("click", function (e) {
                        var selectedIndex = option.getAttribute("data-index");
                        var selectedEmail = storedData[selectedIndex].email;
                        restoreLastSelectedProduct(selectedEmail);
                        loadingMaskShow(selectedEmail);
                        selectUserData(storedData[selectedIndex]);
                        initBlock.style.display = "none";
                    });
                });
                optionsDelete(); //刪除選項

                //帶入輸入的email
                if (customerEmail.value !== null) {
                    document
                        .querySelector("#emailComfirm")
                        .addEventListener("click", function () {
                            if (inputEmail.value.trim() === "") {
                                alert("請輸入Email");
                                return;
                            }
                            customerEmail.value = inputEmail.value.trim();
                            var checkEmailBtn = document.querySelector("#checkEmailBtn");
                            if(checkEmailBtn){
                                document.querySelector("#checkEmailBtn").click();
                            } 
                            initBlock.style.display = "none";
                            //儲存全部資料
                            saveDataToLocalStorage();
                        });
                }
            }
        }

        //手動刪除清單選項
        function optionsDelete() {
            var deleteButtons = document.querySelectorAll(".deleteButton");

            deleteButtons.forEach(function (button) {
                button.addEventListener("click", function (e) {
                    var index = Array.from(
                        document.querySelectorAll(".deleteButton")
                    ).indexOf(e.target);
                    var reStoredData = getLocalStorageData("allUserData");
                    var reAllCachedItemIDs = getLocalStorageData("allCachedItemIDs");
                    var reAllItemData = getLocalStorageData("allItemData");
                    var dataKeys = Object.keys(reStoredData);

                    if (index >= 0) {
                        var userEmail = dataKeys[index];
                        delete reStoredData[userEmail];

                        if (userEmail in reAllCachedItemIDs) {
                            delete reAllCachedItemIDs[userEmail];
                            localStorage.setItem(
                                "allCachedItemIDs",
                                JSON.stringify(reAllCachedItemIDs)
                            );
                        }
                        if (userEmail in reAllItemData) {
                            delete reAllItemData[userEmail];
                            localStorage.setItem(
                                "allItemData",
                                JSON.stringify(reAllItemData)
                            );
                        }
                        if (Object.keys(reStoredData).length > 0) {
                            localStorage.setItem("allUserData", JSON.stringify(reStoredData));
                        } else {
                            localStorage.removeItem("allUserData");
                        }
                    }
                    if (
                        document.querySelector("#popupContent") &&
                        !e.target.closest("#tempDataList")
                    ) {
                        showStoredDataDialog();
                    }
                    if (
                        document.querySelector("#popupContent") &&
                        !e.target.closest("#popupContent")
                    ) {
                        makeUserInputEmail();
                    }
                });
            });
        }

        //取得localStorage資料
        function getLocalStorageData(key) {
            return JSON.parse(localStorage.getItem(key)) || {};
        }

    // ================================
    // AppController 主控制器
    // ================================
    class AppController {
        constructor() {
            this.storageManager = new StorageManager();
            this.uiManager = new UIManager();
            this.formManager = new FormManager();
            this.orderDataManager = new OrderDataManager(this.storageManager);
            
            this._initialize();
        }

        _initialize() {
            this._setupEventListeners();
            this._initializeOnPageLoad();
            this._cleanupExpiredData();
        }

        _setupEventListeners() {
            this._setupMenuEvents();
            this._setupFormEvents();
            this._setupOrderEvents();
        }

        _setupMenuEvents() {
            const menuButton = this.uiManager.getElement('MENU_BUTTON');
            if (menuButton) {
                menuButton.addEventListener('click', () => {
                    this.uiManager.toggleMenu();
                });
            }

            document.addEventListener('click', (e) => {
                const menuButton = this.uiManager.getElement('MENU_BUTTON');
                const menuContent = this.uiManager.getElement('MENU_CONTENT');
                
                if (e.target !== menuButton && e.target !== menuContent) {
                    this.uiManager.closeMenu();
                }
            });

            const saveDataBtn = this.uiManager.getElement('SAVE_DATA_BTN');
            if (saveDataBtn) {
                saveDataBtn.addEventListener('click', () => {
                    this._handleSaveAllData();
                });
            }

            const loadTempDataBtn = this.uiManager.getElement('LOAD_TEMP_DATA_BTN');
            if (loadTempDataBtn) {
                loadTempDataBtn.addEventListener('click', () => {
                    this._handleShowStoredDataDialog();
                });
            }

            const clearItemsBtn = this.uiManager.getElement('CLEAR_ITEMS');
            if (clearItemsBtn) {
                clearItemsBtn.addEventListener('click', () => {
                    this._handleClearItems();
                });
            }
        }

        _setupFormEvents() {
            this.formManager.attachChangeListener((fieldInfo, event) => {
                this._handleFieldChange(fieldInfo, event);
            });

            this.formManager.attachEmailClickListener((currentEmail) => {
                this.formManager.setPreviousEmail(currentEmail);
            });
        }

        _setupOrderEvents() {
            this.orderDataManager.attachApplyButtonListener(() => {
                this._handleApplyButtonClick();
            });
        }

        _initializeOnPageLoad() {
            const basicInfo = this.formManager.getUserBasicInfo();
            
            if (!basicInfo.email) {
                this._showInitialEmailPrompt();
            }
        }

        _showInitialEmailPrompt() {
            const storedData = Object.values(this.storageManager.getAllUserData());
            const isExistingCustomer = this.uiManager.isExistingCustomerOrder();
            const currentEmail = this.formManager.getUserBasicInfo().email;
            
            const content = this.uiManager.buildTempDataListHTML(storedData, isExistingCustomer, currentEmail);
            
            this.uiManager.showInitBlock(
                content,
                () => this._handleEmailConfirm(),
                (index) => this._handleInitialOptionClick(index, storedData),
                (index) => this._handleDeleteOption(index, storedData)
            );
        }

        _handleEmailConfirm() {
            const emailInput = this.uiManager.getCustomerEmailInput();
            
            if (!emailInput) {
                this.uiManager.showAlert(MESSAGES.PLEASE_INPUT_EMAIL);
                return;
            }

            if (!this.formManager.validateEmail(emailInput)) {
                this.uiManager.showAlert('請輸入有效的Email格式');
                return;
            }

            this.formManager.setFieldValue('email', emailInput);
            
            const checkEmailBtn = document.querySelector('#checkEmailBtn');
            if (checkEmailBtn) {
                checkEmailBtn.click();
            }
            
            this.uiManager.hideInitBlock();
            this._saveAllDataToStorage();
        }

        async _handleInitialOptionClick(index, storedData) {
            if (index >= 0 && index < storedData.length) {
                const userData = storedData[index];
                const selectedEmail = userData.email;
                
                try {
                    await this.orderDataManager.restoreSelectedProducts(selectedEmail);
                    this.uiManager.observeLoadingMask(() => {
                        this.orderDataManager.restoreOrderItemsData(selectedEmail);
                    });
                    this._restoreUserData(userData);
                    this.uiManager.hideInitBlock();
                } catch (error) {
                    console.error('Error restoring initial data:', error);
                }
            }
        }

        _handleFieldChange(fieldInfo, event) {
            if (fieldInfo.isEmailField) {
                this._handleEmailFieldChange(fieldInfo, event);
            } else if (fieldInfo.isCityField) {
                this._handleCityFieldChange(fieldInfo);
            } else {
                this._saveCurrentFieldData(fieldInfo);
            }
        }

        _handleEmailFieldChange(fieldInfo, event) {
            const previousEmail = this.formManager.getPreviousEmail();
            const newEmail = fieldInfo.value;
            
            this._saveAllDataToStorage();

            const hasEmptyQuote = this.orderDataManager.hasEmptyQuoteItems();
            if (!hasEmptyQuote && previousEmail && previousEmail !== newEmail) {
                this.storageManager.updateUserEmail(previousEmail, newEmail);
                this.uiManager.showAlert(MESSAGES.EMAIL_CHANGED_ALERT);
            }
        }

        _handleCityFieldChange(fieldInfo) {
            const cityField = this.formManager.getField('order-billing_address_city');
            if (cityField) {
                const currentFieldInfo = {
                    ...fieldInfo,
                    fieldId: 'order-billing_address_city',
                    field: cityField,
                    value: cityField.value
                };
                this._saveCurrentFieldData(currentFieldInfo);
            }
        }

        _saveCurrentFieldData(fieldInfo) {
            const validation = this.formManager.validateRequiredFields();
            
            if (validation.hasEmail && validation.hasValidEmail) {
                const userData = this.formManager.createUserDataObject(
                    validation.email,
                    validation.name,
                    { [fieldInfo.fieldId]: fieldInfo.value }
                );

                this.storageManager.saveUserData(validation.email, userData);
                this.uiManager.showSaveSuccessMessage();
            }
        }

        _saveAllDataToStorage() {
            const validation = this.formManager.validateRequiredFields();
            
            if (validation.hasEmail && validation.hasValidEmail) {
                const formData = this.formManager.collectAllFormData();
                const userData = this.formManager.createUserDataObject(
                    validation.email,
                    validation.name,
                    formData
                );

                this.storageManager.saveUserData(validation.email, userData);
                this.uiManager.showSaveSuccessMessage();
            } else if (validation.hasEmail) {
                const formData = this.formManager.collectAllFormData();
                const userData = this.formManager.createUserDataObject(
                    validation.email,
                    '客戶',
                    formData
                );

                this.storageManager.saveUserData(validation.email, userData);
                this.uiManager.showSaveSuccessMessage();
            }
        }

        _handleSaveAllData() {
            this._saveAllDataToStorage();
            this.uiManager.showAlert(MESSAGES.DATA_SAVED);
        }

        _handleShowStoredDataDialog() {
            const storedData = Object.values(this.storageManager.getAllUserData());
            const isExistingCustomer = this.uiManager.isExistingCustomerOrder();
            const currentEmail = this.formManager.getUserBasicInfo().email;
            
            const content = this.uiManager.buildTempDataListHTML(storedData, isExistingCustomer, currentEmail);
            
            this.uiManager.showTempDataDialog(
                content,
                (index) => this._handleStoredDataOptionClick(index, storedData),
                (index) => this._handleDeleteOption(index, storedData),
                () => this.uiManager.closeDialog()
            );
        }

        async _handleStoredDataOptionClick(index, storedData) {
            if (index < 0 || index >= storedData.length) return;

            const userData = storedData[index];
            const selectedEmail = userData.email;
            const currentEmail = this.formManager.getUserBasicInfo().email;

            this.uiManager.closeDialog();

            if (currentEmail && currentEmail !== selectedEmail) {
                this._showOverwriteConfirmation(userData);
            } else {
                await this._loadSelectedUserData(userData);
            }
        }

        _showOverwriteConfirmation(userData) {
            const confirmHTML = this.uiManager.buildLoadConfirmHTML();
            const dialog = this.uiManager.getElement('USER_DATA_DIALOG');
            
            if (dialog) {
                dialog.innerHTML = confirmHTML;
                dialog.style.cursor = 'unset';
                dialog.style.opacity = '1';
                dialog.showModal();

                const sureBtn = dialog.querySelector('.sureBtn');
                const closeBtn = dialog.querySelector('.closeBtn');

                if (sureBtn) {
                    sureBtn.addEventListener('click', async () => {
                        this.uiManager.closeDialog();
                        await this._overwriteAndLoadData(userData);
                    });
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.uiManager.closeDialog();
                    });
                }
            }
        }

        async _overwriteAndLoadData(userData) {
            try {
                await this.orderDataManager.removeAllSelectedProducts();
                await this.orderDataManager.restoreSelectedProducts(userData.email);
                this.uiManager.observeLoadingMask(() => {
                    this.orderDataManager.restoreOrderItemsData(userData.email);
                });
                this._restoreUserData(userData);
            } catch (error) {
                console.error('Error overwriting and loading data:', error);
            }
        }

        async _loadSelectedUserData(userData) {
            const currentEmail = this.formManager.getUserBasicInfo().email;
            
            if (userData.email === currentEmail) {
                try {
                    await this.orderDataManager.removeAllSelectedProducts();
                    await this.orderDataManager.restoreSelectedProducts(userData.email);
                    this.uiManager.observeLoadingMask(() => {
                        this.orderDataManager.restoreOrderItemsData(userData.email);
                    });
                } catch (error) {
                    console.error('Error loading selected user data:', error);
                }
            } else {
                try {
                    await this.orderDataManager.restoreSelectedProducts(userData.email);
                    this.uiManager.observeLoadingMask(() => {
                        this.orderDataManager.restoreOrderItemsData(userData.email);
                    });
                    this._restoreUserData(userData);
                } catch (error) {
                    console.error('Error loading selected user data:', error);
                }
            }
        }

        _restoreUserData(userData) {
            const nameParts = userData.name.split(' ');
            const lastName = nameParts[0] || '';
            const firstName = nameParts[1] || '';

            this.formManager.restoreFormData(
                userData.data,
                userData.email,
                lastName,
                firstName
            );
        }

        _handleDeleteOption(index, storedData) {
            if (index >= 0 && index < storedData.length) {
                const userEmail = storedData[index].email;
                this.storageManager.deleteUserData(userEmail);
                
                this._handleShowStoredDataDialog();
            }
        }

        async _handleClearItems() {
            const confirmed = this.uiManager.showConfirm(MESSAGES.CONFIRM_CLEAR_ITEMS);
            if (confirmed) {
                try {
                    await this.orderDataManager.removeAllSelectedProducts();
                } catch (error) {
                    console.error('Error clearing items:', error);
                }
            }
        }

        _handleApplyButtonClick() {
            const basicInfo = this.formManager.getUserBasicInfo();
            if (basicInfo.email) {
                this._saveAllDataToStorage();
                this.orderDataManager.saveOrderItemsData(basicInfo.email);
                this.orderDataManager.syncTempData(basicInfo.email);
            }
        }

        _cleanupExpiredData() {
            try {
                const cleanedCount = this.storageManager.cleanupExpiredData();
                if (cleanedCount > 0) {
                    console.log(`Cleaned up ${cleanedCount} expired data entries`);
                }
            } catch (error) {
                console.error('Error cleaning up expired data:', error);
            }
        }
    }

    // ================================
    // 初始化應用程式
    // ================================
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const app = new AppController();
            console.log('Temporary Storage App initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Temporary Storage App:', error);
        }
    });
</script>