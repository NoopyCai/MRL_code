<link href="/static/frontend/Mrl/mrl_luma/zh_Hant_TW/css/emoji.min.css" rel="stylesheet" />

<!-- 功能選單 -->
<div class="menu-button" id="menuButton">
    <div class="menu-icon"></div>
    <div class="menu-content" id="menuContent">
        <button class="menu-item" id="saveDataBtn">儲存</button>
        <button class="menu-item" id="clearItems">清空產品清單</button>
        <button class="menu-item" id="loadTempDataBtn">載入</button>
    </div>
</div>

<!-- 暫存List poppup -->
<dialog id="userDataDialog">
    <h2 style="color: #fff">
        還原客戶暫存資料
        <span class="remonded-text">(若資料在48小時內未受到編輯，將會自動刪除)</span>
    </h2>
    <div id="popupContent"></div>
    <button id="closeDialogBtn">關閉</button>
</dialog>

//顯示儲存成功message
<div id="saveSuccessMessage" class="button-53">
    <p>欄位已成功儲存!</p>
</div>

<dialog id="initBlock">
    <div class="checkEmail">
        <h2 style="margin: 0">請輸入客戶Email：</h2>
        <input type="email" id="customerEmail" />
        <button id="emailComfirm">確認</button>
    </div>
    <div style="margin-top: 30px">
        <h2 style="color: #fff">
            還原客戶暫存資料
            <span class="remonded-text">(若資料在48小時內未受到編輯，將會自動刪除)</span>
        </h2>
        <div id="tempDataList"></div>
    </div>
</dialog>

<style>
    #initBlock {
        display: none;
        top: 10%;
    }

    .checkEmail {
        display: flex;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: solid #fff;
    }

    #emailComfirm {
        position: unset;
        margin-left: 10px;
        background-color: #f0c418;
        color: #514943;
        border-radius: inherit;
        padding: 0.6rem 1rem 0.6rem;
        border: #adadad solid;
    }

    #customerEmail {
        color: #000;
        width: 25rem;
        font-weight: 400;
    }

    dialog {
        opacity: 0.95;
        background-color: #2c2e33;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        margin: auto;
        font-weight: bold;
        letter-spacing: 2px;
        color: #fff;
        cursor: pointer;
        padding: 2.25em 1.5em;
        position: fixed;
        overflow: hidden;
        border: none;
        box-shadow: rgba(0, 0, 0, 0.4) 5px 5px, rgba(0, 0, 0, 0.3) 10px 10px,
            rgba(0, 0, 0, 0.2) 15px 15px, rgba(0, 0, 0, 0.1) 20px 20px,
            rgba(0, 0, 0, 0.05) 25px 25px;
    }

    dialog[open] {
        animation: fadeIn 0.5s ease;
        overflow: auto;
    }

    dialog[open]::-webkit-scrollbar {
        background: #2c2e33;
        width: 10px;
    }

    dialog[open]::-webkit-scrollbar-thumb {
        background: #fff;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    dialog h2 {
        color: #fff;
    }

    .dialogOption {
        color: #fff;
        font-weight: bold;
        padding: 15px;
        transition: background-color 0.3s ease;
        cursor: pointer;
    }

    .dialogOption:hover {
        background-color: #737679;
        color: #2c2e33;
    }

    dialog strong {
        color: #fff;
    }

    dialog p {
        color: #fff;
    }

    dialog button {
        position: relative;
        top: 10px;
        left: 85%;
        padding: 10px 20px;
        background-color: #ff3333;
        color: #ffffff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    dialog button:hover {
        background-color: #f75a5a;
    }

    #remindInputEmail {
        color: red;
        font-weight: bold;
        margin-top: 10px;
    }

    .remonded-text {
        font-size: 12px;
        color: #f4f446;
    }

    .button-53.show {
        opacity: 1;
        transform: rotate(-2deg) translateY(0);
    }

    .button-53 {
        opacity: 0;
        text-align: center;
        background-color: #2ebc4f;
        border: 0 solid #e5e7eb;
        box-sizing: border-box;
        color: #fff;
        display: flex;
        font-size: 1.5rem;
        font-weight: 700;
        justify-content: center;
        line-height: 1.75rem;
        padding: 0.75rem 1.65rem;
        position: fixed;
        width: 100%;
        max-width: 170px;
        cursor: pointer;
        transform: rotate(-2deg) translateY(-50%);
        transition: opacity 0.5s, transform 0.5s;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        top: 12%;
        left: 50%;
    }

    .button-53:focus {
        outline: 0;
    }

    .button-53:after {
        content: "";
        position: absolute;
        border: 1px solid #000000;
        bottom: 4px;
        left: 4px;
        width: calc(100% - 1px);
        height: calc(100% - 1px);
    }

    .menu-button {
        z-index: 2;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 100000;
    }

    .menu-button:hover {
        transform: scale(1.1);
    }

    .menu-icon {
        width: 30px;
        height: 5px;
        background-color: #ffffff;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
    }

    .menu-content {
        background-color: #fff;
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 0;
        height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
    }

    .menu-item {
        display: block;
        width: 100%;
        padding: 16px;
        text-align: center;
        background-color: #ffffff;
        border: none;
        cursor: pointer;
        margin: 0;
        transition: background-color 0.3s ease;
    }

    .menu-item:hover {
        background-color: #007bff;
        color: #fff;
    }

    #loadTempDataBtn {
        background-color: #2f4f4f;
        color: #fff;
    }

    #loadTempDataBtn:hover {
        background-color: #007bff;
        color: #fff;
    }

    .page-main-actions .page-actions._fixed {
        visibility: visible !important;
    }

    .deleteButton {
        position: relative;
        top: -35px;
        left: 95%;
    }

    .em-warning {
        height: 2em;
        width: 2em;
        position: relative;
        left: 130px;
        bottom: 53px;
    }

    #userDataDialog .sureBtn {
        top: 20px;
        left: 70%;
        margin: 10px 0;
    }

    #userDataDialog .closeBtn {
        top: 20px;
        left: 70%;
        margin: 10px 0 10px 25px;
        background-color: #f4f446;
        color: #2c2e33;
    }
</style>
<script>
// ES5語法重構 - 保持原有功能，使用var和傳統function
(function () {
    // ===== 配置常量 =====
    var CONFIG = {
        STORAGE_KEYS: {
            USER_DATA: 'allUserData',
            ITEM_DATA: 'allItemData', 
            CACHED_ITEM_IDS: 'allCachedItemIDs'
        },
        EXPIRY_TIME: 48 * 60 * 60 * 1000 // 48小時
    };
    
    // ===== 1. SRP: 將相關功能分組到物件中 =====
    
    // 本地儲存相關操作
    var StorageHelper = {
        get: function(key) {
            try {
                return JSON.parse(localStorage.getItem(key)) || {};
            } catch (error) {
                return ErrorHandler.handleStorageError('get', key, error);
            }
        },
        
        set: function(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                return ErrorHandler.handleStorageError('set', key, error);
            }
        },
        
        // 移除留在storage的'{}'
        remove: function(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                return ErrorHandler.handleStorageError('remove', key, error);
            }
        },
        
        // 清理過期資料
        cleanExpiredData: function() {
            var now = new Date().getTime();
            var self = this;
            
            var dataKeys = Object.keys(CONFIG.STORAGE_KEYS).map(function(key) {
                return CONFIG.STORAGE_KEYS[key];
            });
            
            dataKeys.forEach(function(key) {
                var data = self.get(key);
                var hasExpiredData = false;
                
                Object.keys(data).forEach(function(userKey) {
                    if (data[userKey].timestamp && (now - data[userKey].timestamp > CONFIG.EXPIRY_TIME)) {
                        delete data[userKey];
                        hasExpiredData = true;
                    }
                });
                
                if (hasExpiredData) {
                    if (Object.keys(data).length === 0) {
                        self.remove(key);
                    } else {
                        self.set(key, data);
                    }
                }
            });
            
            // 將對應 UserData 的 ItemData 和 CachedItemIDs 清除
            var allUserData = this.get(CONFIG.STORAGE_KEYS.USER_DATA);
            var allItemData = this.get(CONFIG.STORAGE_KEYS.ITEM_DATA);
            var allCachedItemIDs = this.get(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS);
            
            var itemDataCleaned = false;
            var cachedItemsCleaned = false;
            
            Object.keys(allItemData).forEach(function(userKey) {
                if (!allUserData.hasOwnProperty(userKey)) {
                    delete allItemData[userKey];
                    itemDataCleaned = true;
                }
            });
            
            Object.keys(allCachedItemIDs).forEach(function(userKey) {
                if (!allUserData.hasOwnProperty(userKey)) {
                    delete allCachedItemIDs[userKey];
                    cachedItemsCleaned = true;
                }
            });
            
            if (itemDataCleaned) {
                if (Object.keys(allItemData).length === 0) {
                    self.remove(CONFIG.STORAGE_KEYS.ITEM_DATA);
                } else {
                    self.set(CONFIG.STORAGE_KEYS.ITEM_DATA, allItemData);
                }
            }
            
            if (cachedItemsCleaned) {
                if (Object.keys(allCachedItemIDs).length === 0) {
                    self.remove(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS);
                } else {
                    self.set(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS, allCachedItemIDs);
                }
            }
        }
    };

    // 表單欄位相關操作
    var FormFieldHelper = {
        fieldIds: [],
        fields: {},
        
        // 取有設定id的欄位
        init: function() {
            var self = this;
            var fieldIds = [];
            var selectors = ['input', 'select', 'textarea'];
            
            selectors.forEach(function(selector) {
                var elements = document.querySelectorAll(selector);
                for (var i = 0; i < elements.length; i++) {
                    if (elements[i].id) {
                        fieldIds.push(elements[i].id);
                    }
                }
            });

            this.fieldIds = fieldIds.filter(function(id) {
                return id !== '';
            });
            
            this.fields = {};
            this.fieldIds.forEach(function(id) {
                self.fields[id] = document.getElementById(id);
            });
            
            return this;
        },
        
        getAllFieldData: function() {
            var data = {};
            var self = this;
            
            this.fieldIds.forEach(function(id) {
                var field = self.fields[id];
                if (!field) return;
                
                if (field.type === "radio") {
                    if (field.checked) data[id] = field.value;
                } else if (field.type === "checkbox") {
                    data[id] = field.checked;
                } else if (field.type === "fieldset") {
                    data[id] = field.querySelector("textarea").value;
                } else {
                    data[id] = field.value;
                }
            });
            return data;
        },
        
        setFieldData: function(userData) {
            var self = this;
            
            Object.keys(this.fields).forEach(function(id) {
                var field = self.fields[id];
                if (!field) return;
                
                if (field.type === "radio" || field.type === "checkbox") {
                    field.checked = false;
                } else if (field.type === "fieldset") {
                    field.querySelector("textarea").value = "";
                } else {
                    field.value = "";
                }
            });

            var emailField = document.querySelector("#email");
            var lastNameField = document.querySelector("#order-billing_address_lastname");
            var firstNameField = document.querySelector("#order-billing_address_firstname");
            
            if (emailField) emailField.value = userData.email;
            if (lastNameField) lastNameField.value = userData.name.split(" ")[0];
            if (firstNameField) firstNameField.value = userData.name.split(" ")[1] || "";

            Object.keys(userData.data).forEach(function(dataId) {
                var field = self.fields[dataId];
                if (!field) return;
                
                if (field.type === "radio") {
                    field.checked = true;
                } else if (field.type === "checkbox") {
                    field.checked = userData.data[dataId];
                } else if (field.type === "fieldset") {
                    field.querySelector("textarea").value = userData.data[dataId];
                } else {
                    field.value = userData.data[dataId];
                }
            });
        }
    };

    // 用戶資料相關操作
    var UserDataHelper = {
        validateEmail: function(email) {
            if (!email) {
                return ErrorHandler.handleValidationError('email', email, 'Email is required');
            }
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            var isValid = emailRegex.test(email);
            if (!isValid) {
                ErrorHandler.handleValidationError('email', email, 'Invalid email format');
            }
            return isValid;
        },
        
        save: function(email, name, fieldData) {
            if (!email || !this.validateEmail(email)) return false; // 沒有email或email格式不正確不儲存
            
            var userData = {
                email: email,
                name: name || '客戶',
                data: fieldData,
                timestamp: new Date().getTime()
            };

            var allUserData = StorageHelper.get(CONFIG.STORAGE_KEYS.USER_DATA);
            allUserData[email] = userData;
            return StorageHelper.set(CONFIG.STORAGE_KEYS.USER_DATA, allUserData);
        },
        
        loadAll: function() {
            var userData = StorageHelper.get(CONFIG.STORAGE_KEYS.USER_DATA);
            return Object.values ? Object.values(userData) : 
                   Object.keys(userData).map(function(key) {
                       return userData[key];
                   });
        },
        
        delete: function(email) {
            var allUserData = StorageHelper.get(CONFIG.STORAGE_KEYS.USER_DATA);
            var allItemData = StorageHelper.get(CONFIG.STORAGE_KEYS.ITEM_DATA);
            var allCachedItemIDs = StorageHelper.get(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS);
            
            delete allUserData[email];
            if (allItemData[email]) delete allItemData[email];
            if (allCachedItemIDs[email]) delete allCachedItemIDs[email];
            
            // 如果還有其他用戶資料 -> 更新資料
            if (Object.keys(allUserData).length > 0) {
                StorageHelper.set(CONFIG.STORAGE_KEYS.USER_DATA, allUserData);
            } else {
                StorageHelper.remove(CONFIG.STORAGE_KEYS.USER_DATA);
            }
            StorageHelper.set(CONFIG.STORAGE_KEYS.ITEM_DATA, allItemData);
            StorageHelper.set(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS, allCachedItemIDs);
        },
        
        // 若客戶有更新email -> 更新資料
        updateEmailKey: function(oldEmail, newEmail) {
            var storageKeys = Object.keys(CONFIG.STORAGE_KEYS).map(function(key) {
                return CONFIG.STORAGE_KEYS[key];
            });
            
            storageKeys.forEach(function(storageKey) {
                var data = StorageHelper.get(storageKey);
                if (data[oldEmail]) {
                    data[newEmail] = data[oldEmail];
                    if (storageKey === CONFIG.STORAGE_KEYS.USER_DATA) {
                        data[newEmail].email = newEmail;
                    }
                    delete data[oldEmail];
                    StorageHelper.set(storageKey, data);
                }
            });
        }
    };

    // 產品項目相關操作
    var ProductItemHelper = {
        generateItemKey: function(itemID) {
            return "item" + "[" + itemID + "]" + "[qty]";
        },
        
        saveItem: function(email, itemID, itemQty, itemSku) {
            var allCachedItemIDs = StorageHelper.get(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS);
            var key = this.generateItemKey(itemID);
            var items = {};
            items[key] = itemQty;

            if (!allCachedItemIDs[email]) allCachedItemIDs[email] = {};
            allCachedItemIDs[email][itemSku] = items;
            StorageHelper.set(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS, allCachedItemIDs);
        },
        
        deleteItem: function(email, itemID) {
            var allCachedItemIDs = StorageHelper.get(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS);
            var itemKey = this.generateItemKey(itemID);

            if (email in allCachedItemIDs) {
                var userCachedItemIDs = allCachedItemIDs[email];
                delete userCachedItemIDs[itemKey];

                if (Object.keys(userCachedItemIDs).length === 0) {
                    delete allCachedItemIDs[email];
                } else {
                    allCachedItemIDs[email] = userCachedItemIDs;
                }
                StorageHelper.set(CONFIG.STORAGE_KEYS.CACHED_ITEM_IDS, allCachedItemIDs);
            }
        },
        
        // 儲存商品資料(交期、備註)
        saveItemData: function(email) {
            var orderTableRows = document.querySelectorAll(".order-tables tbody");
            
            Array.prototype.forEach.call(orderTableRows, function(row) {
                var productSku = row.querySelector(".product-sku-block").innerText.split(":")[1].trim();
                var itemDate_1 = row.querySelector(".col-row-from-date-1 .input-date").value;
                var itemDate_2 = row.querySelector(".col-row-to-date-2 .input-date").value;
                var itemNote = row.querySelector(".col-row-free-text textarea").value;

                var items = {
                    itemDate_1: itemDate_1,
                    itemDate_2: itemDate_2,
                    itemNote: itemNote
                };
                
                if (productSku) {
                    var allItemData = StorageHelper.get('allItemData');
                    if (!allItemData[email]) allItemData[email] = {};
                    allItemData[email][productSku] = items;
                    StorageHelper.set('allItemData', allItemData);
                }
            });
        },
        
        restoreItemData: function(selectedEmail) {
            var allItemData = StorageHelper.get('allItemData');
            if (!(selectedEmail in allItemData)) return;

            var items = allItemData[selectedEmail];
            var orderTableRows = document.querySelectorAll('.order-tables tbody');
            
            Array.prototype.forEach.call(orderTableRows, function(row) {
                var productSku = row.querySelector(".product-sku-block").innerText.split(":")[1].trim();
                if (productSku in items) {
                    var itemData = items[productSku];
                    row.querySelector(".col-row-from-date-1 .input-date").value = itemData.itemDate_1 || "";
                    row.querySelector(".col-row-to-date-2 .input-date").value = itemData.itemDate_2 || "";
                    row.querySelector(".col-row-free-text textarea").value = itemData.itemNote || "";
                }
            });

            // 觸發套用按鈕
            setTimeout(function() {
                var updateBtn = document.querySelector("#mrl_update_attributes");
                if (updateBtn) updateBtn.click();
            }, 2000);
        },
        
        // 還原購物車商品資料
        restoreSelectedProducts: function(selectedEmail) {
            var cacheditemIDs = StorageHelper.get('allCachedItemIDs');
            if (!(selectedEmail in cacheditemIDs)) {
                console.log("暫存的商品資料不存在");
                return;
            }

            var area = ["search", "items", "shipping_method", "totals", "giftmessage", "billing_method"];
            var fieldsPrepare = {};
            var itemsFilter = [];
            var foundObject = cacheditemIDs[selectedEmail];

            Object.keys(foundObject).forEach(function(sku) {
                var itemData = foundObject[sku];
                Object.keys(itemData).forEach(function(key) {
                    var itemIdMatch = key.match(/\[(\d+)\]/);
                    var itemId = itemIdMatch ? itemIdMatch[1] : null;
                    var qtyKey = 'item[' + itemId + '][qty]';
                    var qty = itemData[qtyKey];

                    if (qty !== undefined) {
                        fieldsPrepare[qtyKey] = qty;
                        itemsFilter.push({ item_id: itemId, sku: sku });
                    }
                });
            });

            order.productConfigureSubmit("product_to_add", area, fieldsPrepare, itemsFilter);
        },
        
        // 同步更新storage 中被user remove的商品資料
        syncTempData: function(selectedEmail) {
            var orderTableRows = document.querySelectorAll(".order-tables tbody");
            
            Array.prototype.forEach.call(orderTableRows, function(row) {
                var actions = row.querySelector(".col-actions .admin__control-select");
                if (actions.value === "remove") {
                    var productSku = row.querySelector(".product-sku-block").innerText.split(":")[1].trim();
                    var cachedItemIDs = StorageHelper.get('allCachedItemIDs');
                    var cachedItemDatas = StorageHelper.get('allItemData');

                    if (cachedItemIDs[selectedEmail] && cachedItemIDs[selectedEmail][productSku]) {
                        delete cachedItemIDs[selectedEmail][productSku];
                        StorageHelper.set('allCachedItemIDs', cachedItemIDs);
                    }
                    if (cachedItemDatas[selectedEmail] && cachedItemDatas[selectedEmail][productSku]) {
                        delete cachedItemDatas[selectedEmail][productSku];
                        StorageHelper.set('allItemData', cachedItemDatas);
                    }
                }
            });
        }
    };

    // ===== 2. 統一錯誤處理和通知系統 =====
    var ErrorHandler = {
        logError: function(context, error, data) {
            console.error('[' + context + '] Error:', error, data || '');
        },
        
        handleStorageError: function(operation, key, error) {
            this.logError('Storage', 'Failed to ' + operation + ' key: ' + key, error);
            return operation === 'get' ? {} : false;
        },
        
        handleValidationError: function(field, value, message) {
            this.logError('Validation', field + ' validation failed: ' + message, value);
            return false;
        }
    };

    var NotificationHelper = {
        showSuccess: function(message) {
            var successMessageElement = document.getElementById("saveSuccessMessage");
            if (successMessageElement) {
                successMessageElement.querySelector('p').textContent = message || '欄位已成功儲存!';
                successMessageElement.classList.add("show");
                setTimeout(function() {
                    successMessageElement.classList.remove("show");
                }, 3000);
            }
        },
        
        showAlert: function(message) {
            alert(message);
        },
        
        showConfirm: function(message) {
            return confirm(message);
        }
    };

    var DialogHelper = {
        buildPopupContent: function(dataArray) {
            var content = "";
            var isExistCustomer = this.checkCreateOrderForExistCustomer();
            var currentEmail = document.querySelector("#email").value;

            if (dataArray.length > 0) {
                dataArray.forEach(function(userData, index) {
                    // 使用已存在的客戶進行開單
                    // 如果storage有資料但沒有符合的email 不建立list
                    if (isExistCustomer && userData.email !== currentEmail) return; 
                    
                    content += "<div class='dialogOption' data-index='" + index + "'>";
                    content += "客戶: " + userData.name + "<br/>Email: " + userData.email + "<br>";
                    content += "</div>";
                    content += '<i class="em em-x deleteButton" aria-role="presentation" aria-label="CROSS MARK"></i>';
                });
                
                if (isExistCustomer && content === "") {
                    content += "<p>此客戶目前沒有任何暫存資料。</p>";
                }
            } else {
                content += "<p>目前沒有任何暫存資料。</p>";
            }
            return content;
        },
        
        checkCreateOrderForExistCustomer: function() {
            var pageTitle = document.querySelector('#order-header');
            if (pageTitle) {
                var titleText = pageTitle.textContent.toLowerCase();
                return titleText.includes('for') || titleText.includes('中的');
            }
            return false;
        },
        
        buildCoverDataConfirm: function() {
            return "<div class='remindText'>" +
                   "<h1 style='color: #f4f446;'>載入提醒 </h1>" +
                   "<i class='em em-warning' aria-role='presentation' aria-label='WARNING SIGN'></i>" +
                   "<br>" +
                   "<span style='font-size:16px'>選取載入的資料Email與原本不同，確認要載入覆蓋嗎?</span>" +
                   "</div>" +
                   "<button class='sureBtn'> YES </button>" +
                   "<button class='closeBtn'> NO </button>";
        }
    };

    // ===== 工具函數 =====
    function waitForElm(selector, doc) {
        var scopeDoc = doc || document;
        return new Promise(function(resolve) {
            var el = scopeDoc.querySelector(selector);
            if (el) return resolve(el);

            var observer = new MutationObserver(function() {
                var targetEl = scopeDoc.querySelector(selector);
                if (targetEl) {
                    resolve(targetEl);
                    observer.disconnect();
                }
            });
            observer.observe(scopeDoc, { childList: true, subtree: true });
        });
    }

    // ===== 應用程序主控制器 =====
    var AppController = {
        // 應用初始化
        init: function() {
            var formFields = FormFieldHelper.init();
            var emailField = document.querySelector("#email");
            var lastNameField = document.querySelector("#order-billing_address_lastname");
            var firstNameField = document.querySelector("#order-billing_address_firstname");
            var removeSelectItemNum = 0;
            
            // 清理過期資料
            StorageHelper.cleanExpiredData();
            
            // 初始化用戶輸入Email彈窗
            UIController.makeUserInputEmail();
            
            // 初始化事件監聽器
            EventController.initializeEventListeners(formFields, emailField, lastNameField, firstNameField);
            
            // 初始化產品相關功能
            ProductController.initializeProductHandlers();
        }
    };

    // ===== UI 控制器 =====
    var UIController = {
        makeUserInputEmail: function() {
            if (document.querySelector("#email").value !== "") return;

            var storedData = UserDataHelper.loadAll();
            var popupContent = DialogHelper.buildPopupContent(storedData);
            var initBlock = document.querySelector("#initBlock");
            
            document.getElementById("tempDataList").innerHTML = popupContent;
            initBlock.style.display = "block";

            this.attachUserEmailDialogListeners(storedData, initBlock);
            this.attachDeleteListeners();
        },
        
        attachUserEmailDialogListeners: function(storedData, initBlock) {
            var self = this;
            
            // 選項點擊
            var dialogOptions = document.querySelectorAll(".dialogOption");
            Array.prototype.forEach.call(dialogOptions, function(option) {
                option.addEventListener("click", function() {
                    var selectedIndex = option.getAttribute("data-index");
                    var selectedEmail = storedData[selectedIndex].email;
                    ProductController.restoreSelectedProducts(selectedEmail);
                    self.showLoadingMask(selectedEmail);
                    FormFieldHelper.setFieldData(storedData[selectedIndex]);
                    initBlock.style.display = "none";
                });
            });

            // Email確認按鈕
            document.querySelector("#emailComfirm").addEventListener("click", function() {
                var inputEmail = document.querySelector("#customerEmail");
                if (inputEmail.value.trim() === "") {
                    NotificationHelper.showAlert("請輸入Email");
                    return;
                }
                
                var emailField = document.querySelector("#email");
                var lastNameField = document.querySelector("#order-billing_address_lastname");
                var firstNameField = document.querySelector("#order-billing_address_firstname");
                
                emailField.value = inputEmail.value.trim();
                var checkEmailBtn = document.querySelector("#checkEmailBtn");
                if (checkEmailBtn) checkEmailBtn.click();
                initBlock.style.display = "none";
                
                var name = (lastNameField.value || '') + (firstNameField.value || '');
                var fieldData = FormFieldHelper.getAllFieldData();
                UserDataHelper.save(emailField.value, name, fieldData);
            });
        },

        showStoredDataDialog: function() {
            var storedData = UserDataHelper.loadAll();
            var userDataDialog = document.getElementById("userDataDialog");
            var popupContent = DialogHelper.buildPopupContent(storedData);
            
            var popupContentElement = DialogProcessor.initializeDialog(userDataDialog);
            popupContentElement.innerHTML = popupContent;
            userDataDialog.showModal();

            DialogProcessor.attachCloseListener(userDataDialog);
            DialogProcessor.attachOptionListeners(userDataDialog, storedData);
            this.attachDeleteListeners();
        },

        attachDeleteListeners: function() {
            var self = this;
            var deleteButtons = document.querySelectorAll(".deleteButton");
            Array.prototype.forEach.call(deleteButtons, function(button, index) {
                button.addEventListener("click", function(e) {
                    e.stopPropagation();
                    var storedData = UserDataHelper.loadAll();
                    if (storedData[index]) {
                        UserDataHelper.delete(storedData[index].email);
                        
                        // 重新顯示對話框
                        if (document.querySelector("#popupContent")) {
                            self.showStoredDataDialog();
                        } else if (document.querySelector("#tempDataList")) {
                            self.makeUserInputEmail();
                        }
                    }
                });
            });
        },

        showLoadingMask: function(selectedEmail) {
            var popupLoading = document.querySelector(".popup-loading");
            if (!popupLoading) return;
            
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (!entry.isIntersecting) {
                        ProductItemHelper.restoreItemData(selectedEmail);
                        observer.disconnect();
                    }
                });
            }, { threshold: 0 });

            observer.observe(popupLoading);
        }
    };

    // ===== 事件控制器 =====
    var EventController = {
        initializeEventListeners: function(formFields, emailField, lastNameField, firstNameField) {
            this.initializeMenuListeners();
            this.initializeButtonListeners(formFields, emailField, lastNameField, firstNameField);
            this.initializeFormListeners(emailField);
        },

        initializeMenuListeners: function() {
            var isMenuOpen = false;
            var menuButton = document.getElementById('menuButton');
            var menuContent = document.getElementById('menuContent');
            
            menuButton.addEventListener("click", function() {
                isMenuOpen = !isMenuOpen;
                menuContent.style.width = isMenuOpen ? "120px" : "0";
                menuContent.style.height = isMenuOpen ? "150px" : "0";
            });

            document.addEventListener("click", function(e) {
                if (!menuButton.contains(e.target) && !menuContent.contains(e.target)) {
                    isMenuOpen = false;
                    menuContent.style.width = "0";
                    menuContent.style.height = "0";
                }
            });
        },

        initializeButtonListeners: function(formFields, emailField, lastNameField, firstNameField) {
            // 儲存資料按鈕
            document.getElementById('saveDataBtn').addEventListener("click", function() {
                var email = emailField.value;
                var name = (lastNameField.value || '') + (firstNameField.value || '');
                var fieldData = formFields.getAllFieldData();
                
                if (UserDataHelper.save(email, name, fieldData)) {
                    NotificationHelper.showSuccess();
                }
            });

            // 載入暫存資料按鈕
            document.getElementById('loadTempDataBtn').addEventListener("click", function() {
                UIController.showStoredDataDialog();
            });

            // 清除產品清單
            document.getElementById('clearItems').addEventListener("click", function() {
                if (NotificationHelper.showConfirm("確定清除產品清單嗎?")) {
                    ProductController.removeSelectItem();
                }
            });
        },

        initializeFormListeners: function(emailField) {
            // 記錄當前用戶輸入的Email
            emailField.addEventListener("click", function() {
                emailField.setAttribute("data-previousEmail", emailField.value);
            });

            // 記錄當前輸入的欄位資料
            document.querySelector(".order-details").addEventListener("change", function(e) {
                if (e.target.parentNode.id.includes("sales_order_create_search_grid") ||
                    e.target.parentNode.classList.contains("order-tables")) {
                    return;
                }
                DataSaveProcessor.saveCurrentData(e);
            });
        }
    };

    // ===== 產品控制器 =====
    var ProductController = {
        removeSelectItemNum: 0,

        initializeProductHandlers: function() {
            var self = this;
            
            // 監聽篩選器導致表格變動
            var addPtForm = document.querySelector("#sales_order_create_search_grid");
            if (addPtForm) {
                var addPtFormObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === "childList" || mutation.type === "attributes" || mutation.type === "subtree") {
                            var productItems = document.querySelectorAll("#sales_order_create_search_grid_table tr");
                            if (productItems.length > 0) {
                                self.saveItemitemID(productItems);
                            }
                        }
                    });
                });

                addPtFormObserver.observe(addPtForm, { attributes: false, childList: true, subtree: false });
            }

            var addProductBtn = document.getElementById('add_products');
            if (addProductBtn) {
                addProductBtn.addEventListener("click", function() {
                    var productItems = document.querySelectorAll("#sales_order_create_search_grid_table tr");
                    self.saveItemitemID(productItems);
                });
            }

            // 監聽"套用"按鈕
            this.waitForElm("#mrl_update_attributes").then(function(elm) {
                elm.addEventListener("click", function() {
                    var emailField = document.querySelector("#email");
                    var lastNameField = document.querySelector("#order-billing_address_lastname");
                    var firstNameField = document.querySelector("#order-billing_address_firstname");
                    
                    var email = emailField.value;
                    var name = (lastNameField.value || '') + (firstNameField.value || '');
                    var fieldData = FormFieldHelper.getAllFieldData();
                    
                    UserDataHelper.save(email, name, fieldData);
                    ProductItemHelper.saveItemData(email);
                    ProductItemHelper.syncTempData(email);
                });
            });
        },

        saveItemitemID: function(productItems) {
            var self = this;
            Array.prototype.forEach.call(productItems, function(item) {
                item.addEventListener("click", function() {
                    self.handleEvent(item);
                });
                item.addEventListener("change", function() {
                    self.handleEvent(item);
                });
            });
        },

        handleEvent: function(element) {
            var emailField = document.querySelector("#email");
            var email = emailField.value;
            var itemID = element.closest("tr").querySelector(".col-id").innerText;
            var itemQty = element.closest("tr").querySelector(".col-qty input").value;
            var itemSku = element.closest("tr").querySelector(".col-sku").innerText;
            var status = element.closest("tr").querySelector(".col-select input").checked;

            if (status) {
                ProductItemHelper.saveItem(email, itemID, itemQty, itemSku);
            } else {
                ProductItemHelper.deleteItem(email, itemID);
            }
        },

        removeSelectItem: function() {
            var existProduct = document.querySelectorAll("#order-items td.col-product > span");
            var existProductArr = [];
            var self = this;
            
            Array.prototype.forEach.call(existProduct, function(span) {
                var match = span.id.match(/\d+/);
                if (match) {
                    existProductArr.push(match[0]);
                }
            });

            existProductArr.forEach(function(id) {
                self.removeSelectItemNum++;
                order.removeQuoteItem(id);
            });
        },

        restoreSelectedProducts: function(selectedEmail) {
            ProductItemHelper.restoreSelectedProducts(selectedEmail);
        },

        handleDataRestore: function(selectedEmail, userData) {
            var self = this;
            var waitRemoveItem = new Promise(function(resolve) {
                self.removeSelectItem();
                resolve();
            });
            
            waitRemoveItem.then(function() {
                setTimeout(function() {
                    self.restoreSelectedProducts(selectedEmail);
                    UIController.showLoadingMask(selectedEmail);
                    FormFieldHelper.setFieldData(userData);
                }, 1500 * self.removeSelectItemNum);
                self.removeSelectItemNum = 0;
            });
        },

        waitForElm: function(selector, doc) {
            var scopeDoc = doc || document;
            return new Promise(function(resolve) {
                var el = scopeDoc.querySelector(selector);
                if (el) return resolve(el);

                var observer = new MutationObserver(function() {
                    var targetEl = scopeDoc.querySelector(selector);
                    if (targetEl) {
                        resolve(targetEl);
                        observer.disconnect();
                    }
                });
                observer.observe(scopeDoc, { childList: true, subtree: true });
            });
        }
    };

    // ===== 資料儲存處理器 =====
    var DataSaveProcessor = {
        getFieldValue: function(fieldId, field) {
            if (fieldId === "order-billing_address_city_id") {
                return FormFieldHelper.fields["order-billing_address_city"].value;
            }
            
            if (!field) return null;
            
            if (field.type === "radio" && field.checked) {
                return field.value;
            } else if (field.type === "checkbox") {
                return field.checked;
            } else if (field.type === "fieldset") {
                return field.querySelector("textarea").value;
            } else {
                return field.value;
            }
        },
        
        handleEmailChange: function(email, name, currentPreviousEmail) {
            var fieldData = FormFieldHelper.getAllFieldData();
            UserDataHelper.save(email, name, fieldData);
            
            // 檢查是否需要更新Email
            var checkQuote = document.querySelector("#order-items_grid .empty-text");
            if (!checkQuote && currentPreviousEmail !== email) {
                UserDataHelper.updateEmailKey(currentPreviousEmail, email);
                NotificationHelper.showAlert("原儲存資料的Email已被更改，已自動更新暫存資料");
            }
        },
        
        updateUserFieldData: function(email, name, fieldId, fieldValue) {
            var allUserData = StorageHelper.get(CONFIG.STORAGE_KEYS.USER_DATA);
            if (!allUserData[email]) allUserData[email] = {};
            
            if (!allUserData[email].data) allUserData[email].data = {};
            allUserData[email].email = email;
            allUserData[email].name = name;
            allUserData[email].data[fieldId] = fieldValue;
            allUserData[email].timestamp = new Date().getTime();
            
            StorageHelper.set(CONFIG.STORAGE_KEYS.USER_DATA, allUserData);
            NotificationHelper.showSuccess();
        },

        saveCurrentData: function(e) {
            var emailField = document.querySelector("#email");
            var lastNameField = document.querySelector("#order-billing_address_lastname");
            var firstNameField = document.querySelector("#order-billing_address_firstname");
            
            var currentPreviousEmail = emailField.getAttribute("data-previousEmail");
            var email = emailField.value;
            var name = (lastNameField.value || '') + (firstNameField.value || '');
            var emailFormat = /^[^\s@]+@[^\s@]+\.[^\s@.]+$/;

            // 完全按照原始邏輯：只有在有email和name時才執行
            if (email && name) {
                if (!emailFormat.test(email)) {
                    return;
                }

                var fieldId = e.target.id;
                var field = FormFieldHelper.fields[fieldId];

                if (field === null || field === undefined) {
                    return;
                }

                if (fieldId === "order-billing_address_city_id") {
                    fieldId = "order-billing_address_city";
                    this.updateUserFieldData(email, name, fieldId, FormFieldHelper.fields[fieldId].value);
                } else if (fieldId === "email") {
                    var fieldData = FormFieldHelper.getAllFieldData();
                    UserDataHelper.save(email, name, fieldData);
                    
                    // 檢查變動欄位是否為email
                    var checkQuote = document.querySelector("#order-items_grid .empty-text");
                    if (!checkQuote) {
                        UserDataHelper.updateEmailKey(currentPreviousEmail, email);
                        NotificationHelper.showAlert("原儲存資料的Email已被更改，已自動更新暫存資料");
                    }
                } else {
                    var fieldValue = this.getFieldValue(fieldId, field);
                    if (fieldValue !== null) {
                        this.updateUserFieldData(email, name, fieldId, fieldValue);
                    }
                }
            }
        }
    };

    // ===== 對話框處理器 =====
    var DialogProcessor = {
        initializeDialog: function(userDataDialog) {
            var popupContentElement = document.getElementById("popupContent");
            if (!popupContentElement) {
                userDataDialog.innerHTML = 
                    "<h2>還原客戶暫存資料 <span class='remonded-text'>(若資料在48小時內未受到編輯，將會自動刪除)</span></h2>" +
                    "<div id='popupContent'></div>" +
                    "<button id='closeDialogBtn'>關閉</button>";
                popupContentElement = document.getElementById("popupContent");
            }
            return popupContentElement;
        },
        
        attachCloseListener: function(userDataDialog) {
            document.getElementById("closeDialogBtn").addEventListener("click", function() {
                userDataDialog.close();
            });
        },
        
        attachOptionListeners: function(userDataDialog, storedData) {
            var self = this;
            var dialogOptions = document.querySelectorAll(".dialogOption");
            Array.prototype.forEach.call(dialogOptions, function(option) {
                option.addEventListener("click", function() {
                    var selectedIndex = option.getAttribute("data-index");
                    var selectedEmail = storedData[selectedIndex].email;
                    var emailField = document.querySelector("#email");
                    var currentEmail = emailField.value;
                    
                    if (currentEmail !== selectedEmail && currentEmail !== "") {
                        self.showConfirmOverwriteDialog(userDataDialog, selectedEmail, storedData[selectedIndex]);
                    } else {
                        ProductController.handleDataRestore(selectedEmail, storedData[selectedIndex]);
                        userDataDialog.close();
                    }
                });
            });
        },
        
        showConfirmOverwriteDialog: function(userDataDialog, selectedEmail, userData) {
            userDataDialog.innerHTML = DialogHelper.buildCoverDataConfirm();
            
            document.querySelector("#userDataDialog .closeBtn").addEventListener("click", function() {
                userDataDialog.close();
            });
            
            document.querySelector("#userDataDialog .sureBtn").addEventListener("click", function() {
                ProductController.handleDataRestore(selectedEmail, userData);
                userDataDialog.close();
            });
                 }
     };

    // ===== 初始化應用程序 =====
    AppController.init();
})();
</script>