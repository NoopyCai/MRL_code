<style>
    .breadcrumbs {
        display: none;
    }

    .inspire-close-btn {
        display: none;
        width: 36px;
        height: 36px;
        position: absolute;
        top: 15px;
        z-index: 5;
        font-size: 3.3rem;
        font-weight: 700;
        line-height: 35px;
        right: 10px;
        color: rgb(0, 0, 0, 50%);
        opacity: 70%;
        background-color: white;
        cursor: pointer;
        border-radius: 50%;
        box-shadow: -1px 1px 6px 2px #5959593b;
    }

    .itemImgContainer {
        max-width: 25%;
    }

    .img-wrapper {
        position: relative;
    }

    .img-wrapper .overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        pointer-events: none;
    }

    .img-wrapper .overlay.o-active {
        display: block !important;
    }

    .img1-bt1-itemInfo {
        bottom: -62.5px;
        left: -147px;
    }

    .img1-bt1-itemInfo::after {
        bottom: 50%;
        right: -5px;
    }

    .product-disPrice {
        line-height: 35px;
        color: #c34135;
        font-size: 18px;
    }

    .bt2-itemInfo::after {
        top: -5px;
    }

    .itemInfo {
        visibility: hidden;
        user-select: none;
        width: 430px;
        max-width: 430px;
        min-width: 230px;
        opacity: 0;
        height: 105px;
        padding: 8px 15px 8px 0;
        position: absolute;
        transform: translateX(-45%) scale(0);
        background-color: #fff;
        border-radius: 5px;
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        transition: 0.3s ease-out;
    }

    .itemInfo p {
        font-family: "Noto Sans TC", sans-serif;
        margin-bottom: 0;
        font-size: 18px;
        font-weight: bold;
    }

    .itemInfo .itemInfo-text .product-title {
        letter-spacing: 0;
    }

    .product-title {
        letter-spacing: 1px;
    }

    .product-oldPrice {
        text-decoration: line-through;
        color: gray;
        font-size: 16px;
    }

    .rwdDot {
        padding-inline-start: 20px !important;
        margin-block-end: 0 !important;
    }

    .img-container {
        width: 100%;
        height: 100%;
        position: relative;
        text-align: center;
        cursor: pointer;
    }

    .arrow {
        margin-left: 12px;
        font-size: 18px;
    }

    .btn {
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 0.5px solid #999;
        background-color: #fff;
        box-shadow: rgba(0, 0, 0, 0.5) 0px 80px 80px,
            rgba(0, 0, 0, 0.25) 0px -20px 40px,
            rgba(0, 0, 0, 0.25) 0px 10px 20px,
            rgba(0, 0, 0, 0.3) 0px 20px 20px,
            rgba(0, 0, 0, 0.2) 0px -5px 10px,
            rgba(0, 0, 0, 0.15) 0px -2px 5px;
        left: 65%;
        top: 40%;
        animation: fadeInOut 1.8s alternate infinite;
        transform: translate(-50%, -50%);
        transition: 0.2s ease-in-out;
        cursor: pointer;
        z-index: 2;
    }

    .btn a {
        text-decoration: none;
        color: #333333;
        display: block;
        height: 0;
    }

    .btn.Notactive {
        animation: none;
        left: 0 !important;
        right: 0 !important;
        width: 0;
        height: 0;
        margin: auto;
    }

    .btn1.Notactive {
        top: 3% !important;
    }

    .btn2.Notactive {
        top: 22% !important;
    }

    .btn3.Notactive {
        top: 41% !important;
    }

    .btn4.Notactive {
        top: 60% !important;
    }

    .btn5.Notactive {
        top: 79% !important;
    }

    .Infoactive {
        visibility: visible !important;
        opacity: 1 !important;
        animation: popup 0.5s;
        transform: translateX(-45%) scale(1);
        display: flex;
        align-items: center;
        justify-content: start;
        text-align: left;
    }

    .inspire-close-btn.active {
        display: block !important;
    }

    #find_inspire_carousel .owl-dots {
        margin-bottom: 50px;
    }

    .page-layout-2columns-left .sidebar-main {
        padding: 0 !important;
    }

    /* 導構圖產品位置 */
    .item-1018412 {
        left: 25% !important;
        top: 33% !important;
    }

    .item-22-0119-0-19 {
        left: 96% !important;
        top: 70% !important;
    }

    .item-23-0059-1-19 {
        left: 82% !important;
        top: 32% !important;
    }

    .item-21-0021-0-19 {
        left: 55% !important;
        top: 22% !important;
    }

    .item-13-0017-0-19 {
        left: 52% !important;
        top: 43% !important;
    }

    @keyframes fadeInOut {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    @keyframes popup {
        0% {
            transform: scale(0) translateX(-45%);
        }

        20% {
            transform: scale(1.1) translateX(-45%);
        }

        50% {
            transform: scale(0.95) translateX(-45%);
        }

        80% {
            transform: scale(1.05) translateX(-45%);
        }

        100% {
            transform: scale(1) translateX(-45%);
        }
    }

    @media (min-width: 768px) {
        .nav-sections {
            margin-bottom: 0 !important;
        }
    }

    @media (max-width: 1440px) {
        .itemInfo {
            width: 380px;
            max-width: 380px;
            min-width: 225px;
            height: 60px;
        }

        .itemInfo .itemInfo-text .product-title,
        .itemInfo .itemInfo-text .product-disPrice,
        .itemInfo .itemInfo-text .product-oldPrice {
            font-size: 12px;
        }

        .itemImgContainer {
            max-width: 17%;
        }
    }

    @media (max-width: 996px) {
        .img-container {
            position: relative;
        }

        .itemInfoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .itemInfoContainer::-webkit-scrollbar {
            display: none;
        }

        .mobile-items-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .itemInfoContainer.expanded .mobile-items-wrapper {
            min-height: 180%;
            padding: 0 0 25% 0;
        }

        .itemInfoContainer .btn {
            position: absolute !important;
        }

        .itemInfoContainer.expanded .btn {
            position: relative !important;
        }

        .itemInfo {
            position: relative;
            left: 0;
            visibility: visible !important;
            background-color: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            height: 70px;
            animation: none !important;
        }

        .itemImgContainer {
            max-width: 17% !important;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .itemInfo-text {
            flex: 1;
            padding-right: 10px;
        }

        .product-disPrice {
            line-height: normal !important;
        }

        .btn1.Notactive {
            top: -10% !important;
        }

        .btn2.Notactive {
            top: 5% !important;
        }

        .btn3.Notactive {
            top: 21% !important;
        }

        .btn4.Notactive {
            top: 37% !important;
        }

        .btn5.Notactive {
            top: 53% !important;
        }

        .Infoactive {
            justify-content: left;
            gap: 10px;
        }

        .itemInfoContainer.expanded .btn:not(.active) .itemInfo {
            opacity: 0.3 !important;
        }

        /* 導構圖產品位置 - 移動端 */
        .item-1018412 {
            left: 17% !important;
            top: 49% !important;
        }

        .item-22-0119-0-19 {
            left: 59% !important;
            top: 55% !important;
        }

        .item-23-0059-1-19 {
            left: 85% !important;
            top: 52% !important;
        }

        .item-21-0021-0-19 {
            left: 54% !important;
            top: 41% !important;
        }

        .item-13-0017-0-19 {
            left: 49% !important;
            top: 56% !important;
        }

        @keyframes popup {
            0% {
                transform: scale(0) translateX(-50%);
            }

            20% {
                transform: scale(1.1) translateX(-50%);
            }

            50% {
                transform: scale(0.95) translateX(-50%);
            }

            80% {
                transform: scale(1.05) translateX(-50%);
            }

            100% {
                transform: scale(1) translateX(-50%);
            }
        }
    }

    @media (max-width: 768px) {
        .tableImg {
            width: 100% !important;
        }

        .btn {
            border: none;
        }

        .itemInfo {
            min-width: 260px;
            width: 250px;
            height: 60px;
            transform: translateX(-50%) scale(0);
        }

        .Infoactive {
            transform: translateX(-50%) scale(1);
        }

        .product-title {
            font-size: 11px !important;
            letter-spacing: 0;
        }

        .product-disPrice {
            font-size: 12px !important;
            line-height: 0;
        }

        .product-oldPrice {
            font-size: 10px !important;
        }

        .itemInfo::after {
            display: none;
        }

        .bt1-itemInfo::after {
            bottom: -5px !important;
            right: 47% !important;
        }

        .bt2-itemInfo::after {
            right: 11% !important;
        }

        .bt3-itemInfo::after {
            right: 30% !important;
            bottom: 0;
            top: -5px;
        }

        .itemImgContainer {
            max-width: 25% !important;
            margin-left: 5px;
        }
    }
</style>


<div class="category-banner">
    <div class="img-container">
        <div class="img-wrapper">
            <picture>
                <source srcset="{{media url=catalog/category/2025/2025_4M_bedroom_mcm_catgM_w500xh370px_p1.jpg}}"
                    media="(max-width: 996px)" />
                <source srcset="{{media url=catalog/category/2025/2025_4M_bedroom_mcm_catg_w1920xh850px_p1.jpg}}"
                    media="(min-width: 768px)" />
                <img class="guide btn-trigger select-content" ga-content-type="北歐復古臥室佈置" ga-click-text="北歐復古臥室佈置_白點"
                    style="margin: inherit; width: 100%"
                    src="{{media url=catalog/category/2025/2025_4M_bedroom_mcm_catg_w1920xh850px_p1.jpg}}" alt="" />
            </picture>
            <div class="overlay"></div>
        </div>
        <div class="itemInfoContainer select-content" ga-content-type="北歐復古臥室佈置" ga-click-text="北歐復古臥室佈置_白點">
            <div class="btn btn1 item-23-0059-1-19 select-item"
                data-ga-item-id="23-0059-1-19" data-ga-item-index="北歐復古臥室佈置" data-ga-label="【北歐復古】Antony 復古綠布雙人床架/雙人標準 (5x6.2) 赤栗棕">
                <a href="" target="_blank">
                    <div class="itemInfo bt1-itemInfo" data-ga-item-id="23-0059-1-19">
                        <div class="itemImgContainer">
                            <img class="itemImg" src="" />
                        </div>

                        <div class="itemInfo-text">
                            <p class="product-title"></p>
                            <p>
                                <span class="product-disPrice"></span>
                                <span class="product-oldPrice"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="btn btn2 item-22-0119-0-19 select-item" data-ga-item-id="22-0119-0-19" data-ga-item-index="北歐復古臥室佈置" data-ga-label="【北歐復古】Antony 實木捲簾床頭櫃 赤栗棕">
                <a href="" target="_blank">
                    <div class="itemInfo bt2-itemInfo" data-ga-item-id="22-0119-0-19">
                        <div class="itemImgContainer">
                            <img class="itemImg" src="" />
                        </div>
                        <div class="itemInfo-text">
                            <p class="product-title"></p>
                            <p>
                                <span class="product-disPrice"></span>
                                <span class="product-oldPrice"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="btn btn3 item-21-0021-0-19 select-item" data-ga-item-id="21-0021-0-19" data-ga-item-index="北歐復古臥室佈置" data-ga-label="【北歐復古】Antony 實木翻轉化妝桌 赤栗棕">
                <a href="" target="_blank">
                    <div class="itemInfo bt3-itemInfo" data-ga-item-id="21-0021-0-19">
                        <div class="itemImgContainer">
                            <img class="itemImg" src="" />
                        </div>
                        <div class="itemInfo-text">
                            <p class="product-title"></p>
                            <p>
                                <span class="product-disPrice"></span>
                                <span class="product-oldPrice"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="btn btn4 item-1018412 select-item" data-ga-item-id="1018412" data-ga-item-index="北歐復古臥室佈置" data-ga-label="Fika 布單人椅 麥穗色">
                <a href="" target="_blank">
                    <div class="itemInfo bt4-itemInfo" data-ga-item-id="1018412">
                        <div class="itemImgContainer">
                            <img class="itemImg" src="" />
                        </div>
                        <div class="itemInfo-text">
                            <p class="product-title"></p>
                            <p>
                                <span class="product-disPrice"></span>
                                <span class="product-oldPrice"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="btn btn5 item-13-0017-0-19 select-item" data-ga-item-id="13-0017-0-19" data-ga-item-index="北歐復古臥室佈置" data-ga-label="【北歐復古】Antony 化妝凳 赤栗棕">
                <a href="" target="_blank">
                    <div class="itemInfo bt5-itemInfo" data-ga-item-id="13-0017-0-19">
                        <div class="itemImgContainer">
                            <img class="itemImg" src="" />
                        </div>
                        <div class="itemInfo-text">
                            <p class="product-title"></p>
                            <p>
                                <span class="product-disPrice"></span>
                                <span class="product-oldPrice"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <div class="inspire-close-btn" id="">&#215;</div>
    </div>
</div>

<script>
    require(["jquery", "owlcarousel", "Mrl_ProductElement"], function ($) {

        autoGetItemInfo();

        //自動取商品資料
        function autoGetItemInfo() {
            const inspireItem = document.querySelectorAll(
                ".itemInfoContainer .btn"
            );
            const inspireSkuList = getUniqueSkus(inspireItem);
            const combinedSkuList = [
                ...new Set(inspireSkuList),
            ];
            console.log(combinedSkuList, "combinedSkuList");

            fetchProductData(combinedSkuList);

            localStorage.setItem("storedProductData", Date.now());

        }

        //檢查資料是否過期
        function isDataExpired(refreshTime) {
            const expirationTime = 1000 * 60 * 60;
            const currentTime = Date.now();
            return currentTime - refreshTime >= expirationTime;
        }

        //取商品sku
        function getUniqueSkus(items) {
            const skuList = [];
            items.forEach((item) => {
                const sku = item.getAttribute("data-ga-item-id");
                if (!skuList.includes(sku)) {
                    skuList.push(sku);
                }
            });
            return skuList;
        }

        //依照sku取商品資訊
        function fetchProductData(skuList) {
            mrl_prductElement.getProducts(
                skuList,
                ($fields = "sku,name,image,price,MRL_discount_price,url_key"),
                ($page = 1),
                ($page_size = skuList.length)
            )
                //success =>更新商品資訊
                .done((success) => {
                    const productData = success;
                    const timestamp = Date.now();
                    updateInspireElements(productData);

                    localStorage.setItem("storedProductData", JSON.stringify(productData));
                    localStorage.setItem(
                        "DataTimestamp_update",
                        JSON.stringify(timestamp)
                    );
                    // console.log(productData, "第一次取得的資料");
                })
                .fail((error) => {  // .error 應該改為 .fail
                    console.error("Failed to fetch product data:", error);
                });
        }

        //更新商品資訊
        function updateInspireElements(success) {
            console.log(success, "success");
            updateElementsBySKU(success, ".itemInfoContainer .btn", ".btn",
                (container) => ({
                    image: container.querySelector(".itemImg"),
                    source: container.querySelector("source"),
                    name: container.querySelector(".product-title"),
                    discountPrice: container.querySelector(".product-disPrice"),
                    oldPrice: container.querySelector(".product-oldPrice"),
                    links: [container.querySelector("a")],
                })
            );
        }

        function updateProductInfo(product, containerSelectors) {
            let { image, url_key, name, price, MRL_discount_price } = product;
            let productDisPrice = parseInt(MRL_discount_price).toLocaleString();
            let productOldPrice = parseInt(price).toLocaleString();

            //img
            if (containerSelectors.image) {
                containerSelectors.image.src = `{{media url=catalog/product/cache/912f4218b83600a6f47af6c76f1f9667${image}}}`;
            }
            if (containerSelectors.source) {
                containerSelectors.source.srcset = `{{media url=catalog/product/cache/912f4218b83600a6f47af6c76f1f9667${image}}}`;
            }

            //link
            if (containerSelectors.links) {
                containerSelectors.links.forEach((link) => {
                    link.href = `${url_key}.html`;
                });
            }

            //name
            if (containerSelectors.name) {
                containerSelectors.name.innerHTML = name;
            }

            //price
            if (containerSelectors.discountPrice) {
                if (productDisPrice === "0") {
                    containerSelectors.discountPrice.innerHTML = `$${productOldPrice}`;
                    containerSelectors.discountPrice.style.color = "black";
                } else {
                    containerSelectors.discountPrice.innerHTML = `$${productDisPrice}<span class="disText" style="font-size: 1.1rem; color:#666666; font-weight:400"> (售價已折) </span>`;
                    containerSelectors.discountPrice.style.color = "#C24035";
                }
            }

            // 更新原價
            if (containerSelectors.oldPrice) {
                if (productDisPrice !== "0") {
                    containerSelectors.oldPrice.innerHTML = `$${productOldPrice}`;
                } else {
                    containerSelectors.oldPrice.innerHTML = "";
                }
            }
        }

        //SKU更新
        function updateElementsBySKU(success, containerSelector, skuSelector, containerSelectorsCallback) {
            const containers = document.querySelectorAll(containerSelector);

            containers.forEach((container) => {
                let sku = container.getAttribute("data-ga-item-id") || container.querySelector(skuSelector).getAttribute("data-ga-item-id");
                let skuIndex = success[0].data.items.findIndex((item) => item.sku === sku);

                if (skuIndex >= 0) {
                    let product = success[0].data.items[skuIndex];
                    let containerSelectors = containerSelectorsCallback(container);

                    updateProductInfo(product, containerSelectors);
                }
            });
        }

        function mobileExpand() {
            const mobileItemContainer = document.createElement("div");
            mobileItemContainer.classList.add("mobileItemContainer");
            document.querySelector(".itemInfoContainer").appendChild(mobileItemContainer);

            const allBtn = document.querySelectorAll(".itemInfoContainer .btn");
            allBtn.forEach((btn) => {
                mobileItemContainer.appendChild(btn);
            });
        }

        // 修改 initMobileView 函數
        function initMobileView() {
            if (window.innerWidth < 996) {
                const itemContainer = document.querySelector('.itemInfoContainer');

                // 檢查是否已經有wrapper，沒有的話才創建
                if (!document.querySelector('.mobile-items-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mobile-items-wrapper';

                    const buttons = Array.from(itemContainer.querySelectorAll('.btn'));
                    buttons.forEach(btn => {
                        wrapper.appendChild(btn);
                    });

                    itemContainer.appendChild(wrapper);
                }

                // 初始化時設置中間按鈕為active
                updateActiveItems();

                // 監聽滾動事件
                itemContainer.addEventListener('scroll', () => {
                    updateActiveItems();
                });
            }
        }

        function updateActiveItems() {
            const itemContainer = document.querySelector('.itemInfoContainer');
            const wrapper = document.querySelector('.mobile-items-wrapper');
            const buttons = Array.from(wrapper.querySelectorAll('.btn'));
            const containerRect = itemContainer.getBoundingClientRect();
            const containerHeight = containerRect.height;
            const scrollTop = itemContainer.scrollTop;
            const maxScroll = itemContainer.scrollHeight - containerHeight;

            buttons.forEach((btn, index) => {
                const rect = btn.getBoundingClientRect();
                const btnTop = rect.top - containerRect.top;
                const btnCenter = btnTop + (rect.height / 2);

                // 計算按鈕在容器中的相對位置（百分比）
                const btnPosition = (btnCenter / containerHeight) * 100;

                // 基本判斷：按鈕在中間區域時
                let shouldBeActive = btnPosition >= 5 && btnPosition <= 75;

                // 特殊情況：滾動到頂部時
                if (scrollTop < 10) {
                    shouldBeActive = shouldBeActive || index === 0;
                }

                // 特殊情況：滾動到底部時
                if (maxScroll - scrollTop < 10) {
                    shouldBeActive = shouldBeActive || index === buttons.length - 1;
                }

                // 應用active狀態
                if (shouldBeActive && itemContainer.classList.contains('expanded')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 在頁面加載和視窗大小改變時初始化移動端視圖
        $(document).ready(() => {
            initMobileView();
            $(window).on('resize', initMobileView);
        });

        setTimeout(function () {
            require(["jquery"], function ($) {
                $(".find_inspire").on("click", function (event) {
                    event.stopPropagation();
                    if (
                        !$(event.target).closest(".itemInfo").length &&
                        !$(event.target).closest(".btn").length
                    ) {
                        $(".overlay").removeClass("o-active");
                        $(".itemInfo").removeClass("Infoactive");
                        $(".btn").removeClass("Notactive");
                        $(".inspire-close-btn").removeClass("active");
                        $(".check-more-btn").removeClass("check-more-active");
                        $(".itemInfoContainer").removeClass("expanded");
                    }
                });

                if (window.innerWidth < 768) {
                    $(".check-more-btn button a").each(function () {
                        $(this).text("More " + String.fromCharCode(9658));
                    });
                }

                $(".img-container").click(function (event) {
                    event.stopPropagation();

                    var container = $(this).closest(".img-container");
                    var itemInfoContainer = container.find(".itemInfoContainer");
                    var btn = container.find(".btn");
                    var overlay = container.find(".overlay");
                    var closeBtn = container.find(".inspire-close-btn");
                    var isActive = overlay.hasClass("o-active");

                    // 重置所有元素
                    $(".img-container .overlay").removeClass("o-active");
                    $(".img-container .itemInfo").removeClass("Infoactive");
                    $(".img-container .btn").removeClass("Notactive");
                    $(".img-container .inspire-close-btn").removeClass("active");
                    $(".itemInfoContainer").removeClass("vertical-layout expanded");

                    if (!isActive) {
                        overlay.addClass("o-active");
                        itemInfoContainer.addClass("vertical-layout expanded");
                        container.find(".itemInfo").addClass("Infoactive");
                        btn.addClass("Notactive");
                        closeBtn.addClass("active");

                        // 在展開時處理移動端視圖
                        if (window.innerWidth < 996) {
                            setTimeout(() => {
                                // 計算需要滾動到的位置
                                const wrapper = itemInfoContainer.find('.mobile-items-wrapper');
                                const buttons = wrapper.find('.btn');
                                const middleButtonIndex = Math.floor(buttons.length / 2);
                                const middleButton = buttons.eq(middleButtonIndex);
                                const containerHeight = itemInfoContainer.height();
                                const buttonTop = middleButton.position().top;
                                const scrollPosition = buttonTop - (containerHeight / 2) + (middleButton.height() / 2);

                                // 平滑滾動到中間位置
                                itemInfoContainer.animate({
                                    scrollTop: scrollPosition
                                }, 300, function () {
                                    // 滾動完成後更新active狀態
                                    updateActiveItems();
                                });
                            }, 100);
                        }
                    }
                });

                // 關閉按鈕處理
                $(".inspire-close-btn").click(function (event) {
                    event.stopPropagation();
                    var container = $(this).closest(".img-container");
                    container.find(".overlay").removeClass("o-active");
                    container.find(".itemInfo").removeClass("Infoactive");
                    container.find(".btn").removeClass("Notactive");
                    container.find(".itemInfoContainer").removeClass("vertical-layout expanded");
                    $(this).removeClass("active");
                });
            });
        }, 3000);
    });
</script>